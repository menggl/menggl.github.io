<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="ObjectStreamClass,ObjectStreamField,FieldReflector,序列化和反序列化,Serializable,Externalizable,readResolve,writeObject,readObject," />










<meta name="description" content="Java对象序列化new ObjectOutputStream123456789101112131415161718public ObjectOutputStream(OutputStream out) throws IOException &amp;#123;	verifySubclass();	bout = new BlockDataOutputStream(out);	handles = new H">
<meta name="keywords" content="ObjectStreamClass,ObjectStreamField,FieldReflector,序列化和反序列化,Serializable,Externalizable,readResolve,writeObject,readObject">
<meta property="og:type" content="article">
<meta property="og:title" content="Java对象序列化和反序列化源码解读">
<meta property="og:url" content="http://menggl.github.io/2018/01/14/2018-01-14Java对象序列化反序列化源码解读/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Java对象序列化new ObjectOutputStream123456789101112131415161718public ObjectOutputStream(OutputStream out) throws IOException &amp;#123;	verifySubclass();	bout = new BlockDataOutputStream(out);	handles = new H">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-09-26T11:34:09.503Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java对象序列化和反序列化源码解读">
<meta name="twitter:description" content="Java对象序列化new ObjectOutputStream123456789101112131415161718public ObjectOutputStream(OutputStream out) throws IOException &amp;#123;	verifySubclass();	bout = new BlockDataOutputStream(out);	handles = new H">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://menggl.github.io/2018/01/14/2018-01-14Java对象序列化反序列化源码解读/"/>





  <title>Java对象序列化和反序列化源码解读 | Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://menggl.github.io/2018/01/14/2018-01-14Java对象序列化反序列化源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="menggl">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Java对象序列化和反序列化源码解读</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-14T12:39:04+08:00">
                2018-01-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="Java对象序列化"><a href="#Java对象序列化" class="headerlink" title="Java对象序列化"></a>Java对象序列化</h3><p>new ObjectOutputStream<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ObjectOutputStream</span><span class="params">(OutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	verifySubclass();</span><br><span class="line">	bout = <span class="keyword">new</span> BlockDataOutputStream(out);</span><br><span class="line">	handles = <span class="keyword">new</span> HandleTable(<span class="number">10</span>, (<span class="keyword">float</span>) <span class="number">3.00</span>);</span><br><span class="line">	subs = <span class="keyword">new</span> ReplaceTable(<span class="number">10</span>, (<span class="keyword">float</span>) <span class="number">3.00</span>);</span><br><span class="line">	enableOverride = <span class="keyword">false</span>;</span><br><span class="line">	writeStreamHeader();</span><br><span class="line"><span class="comment">/*protected void writeStreamHeader() throws IOException &#123;</span></span><br><span class="line"><span class="comment">	bout.writeShort(STREAM_MAGIC);// 在文件头写入 ac ed</span></span><br><span class="line"><span class="comment">	bout.writeShort(STREAM_VERSION);// 在文件头写入00 05</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">	bout.setBlockDataMode(<span class="keyword">true</span>);<span class="comment">// 设置blockDataMode为true</span></span><br><span class="line">	<span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">		debugInfoStack = <span class="keyword">new</span> DebugTraceInfoStack();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		debugInfoStack = <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>output.writeObject(p)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (enableOverride) &#123; <span class="comment">// 如果为true，调用writeObjectOverride方法而不是writeObject(obj,false)方法</span></span><br><span class="line">		writeObjectOverride(obj);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		writeObject0(obj, <span class="keyword">false</span>);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">		<span class="keyword">if</span> (depth == <span class="number">0</span>) &#123;</span><br><span class="line">			writeFatalException(ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">throw</span> ex;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject0</span><span class="params">(Object obj, <span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> oldMode = bout.setBlockDataMode(<span class="keyword">false</span>);<span class="comment">// 切换块数据模式为false，切换模式会把数据写入buffer中</span></span><br><span class="line"><span class="comment">/*boolean setBlockDataMode(boolean mode) throws IOException &#123; // ObjectOutputStream中的</span></span><br><span class="line"><span class="comment">	if (blkmode == mode) &#123;//如果模式相等，返回旧模式</span></span><br><span class="line"><span class="comment">		return blkmode;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	drain();// 如果模式转换了</span></span><br><span class="line"><span class="comment">	blkmode = mode;</span></span><br><span class="line"><span class="comment">	return !blkmode;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">void drain() throws IOException &#123;</span></span><br><span class="line"><span class="comment">	if (pos == 0) &#123;// 没数据可以写入，即使之前是数据块模式，如果没有数据可以写入，也是不会写任何东西的</span></span><br><span class="line"><span class="comment">		return;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	if (blkmode) &#123;// 如果原来的模式是数据块模式，现在要转换成非数据块模式，这里需要将数据块头消息写入，再写入数据块</span></span><br><span class="line"><span class="comment">		writeBlockHeader(pos);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	out.write(buf, 0, pos);</span></span><br><span class="line"><span class="comment">	pos = 0;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">private void writeBlockHeader(int len) throws IOException &#123;</span></span><br><span class="line"><span class="comment">	if (len &lt;= 0xFF) &#123;// 如果缓冲中的数据长度小于0xFF，先写入(byte)0x77一个字节，再写入数据长度一个字节</span></span><br><span class="line"><span class="comment">		hbuf[0] = TC_BLOCKDATA;</span></span><br><span class="line"><span class="comment">		hbuf[1] = (byte) len;</span></span><br><span class="line"><span class="comment">		out.write(hbuf, 0, 2);</span></span><br><span class="line"><span class="comment">	&#125; else &#123; // 如果缓冲中的数据长度大于0xFF，先写入(byte)0x7A一个字节，再将长度当做四个字节写入之后的位置上</span></span><br><span class="line"><span class="comment">		hbuf[0] = TC_BLOCKDATALONG;</span></span><br><span class="line"><span class="comment">		Bits.putInt(hbuf, 1, len);</span></span><br><span class="line"><span class="comment">		out.write(hbuf, 0, 5);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">public void write(byte b[], int off, int len) throws IOException &#123;// 将缓冲中的数据写入输出流</span></span><br><span class="line"><span class="comment">	if (b == null) &#123;</span></span><br><span class="line"><span class="comment">		throw new NullPointerException();</span></span><br><span class="line"><span class="comment">	&#125; else if ((off &lt; 0) || (off &gt; b.length) || (len &lt; 0) ||</span></span><br><span class="line"><span class="comment">			   ((off + len) &gt; b.length) || ((off + len) &lt; 0)) &#123;</span></span><br><span class="line"><span class="comment">		throw new IndexOutOfBoundsException();</span></span><br><span class="line"><span class="comment">	&#125; else if (len == 0) &#123;</span></span><br><span class="line"><span class="comment">		return;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	for (int i = 0 ; i &lt; len ; i++) &#123;</span></span><br><span class="line"><span class="comment">		write(b[off + i]);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">	depth++;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// handle previously written and non-replaceable objects</span></span><br><span class="line">		<span class="keyword">int</span> h;</span><br><span class="line">		<span class="keyword">if</span> ((obj = subs.lookup(obj)) == <span class="keyword">null</span>) &#123;<span class="comment">// 替换表中查找？</span></span><br><span class="line">			writeNull();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!unshared &amp;&amp; (h = handles.lookup(obj)) != -<span class="number">1</span>) &#123;</span><br><span class="line">			writeHandle(h);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">			writeClass((Class) obj, unshared);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ObjectStreamClass) &#123;</span><br><span class="line">			writeClassDesc((ObjectStreamClass) obj, unshared);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		Object orig = obj;</span><br><span class="line">		Class&lt;?&gt; cl = obj.getClass();<span class="comment">// 获取对象的class</span></span><br><span class="line">		ObjectStreamClass desc;</span><br><span class="line">		<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">			Class&lt;?&gt; repCl;</span><br><span class="line">			desc = ObjectStreamClass.lookup(cl, <span class="keyword">true</span>);<span class="comment">// 生成Object的一个描述对象出来</span></span><br><span class="line">			<span class="keyword">if</span> (!desc.hasWriteReplaceMethod() ||</span><br><span class="line">				(obj = desc.invokeWriteReplace(obj)) == <span class="keyword">null</span> ||</span><br><span class="line">				(repCl = obj.getClass()) == cl)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			cl = repCl;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (enableReplace) &#123;</span><br><span class="line">			Object rep = replaceObject(obj);</span><br><span class="line">			<span class="keyword">if</span> (rep != obj &amp;&amp; rep != <span class="keyword">null</span>) &#123;</span><br><span class="line">				cl = rep.getClass();</span><br><span class="line">				desc = ObjectStreamClass.lookup(cl, <span class="keyword">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			obj = rep;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// if object replaced, run through original checks a second time</span></span><br><span class="line">		<span class="keyword">if</span> (obj != orig) &#123; </span><br><span class="line">			subs.assign(orig, obj);</span><br><span class="line">			<span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">				writeNull();</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!unshared &amp;&amp; (h = handles.lookup(obj)) != -<span class="number">1</span>) &#123;</span><br><span class="line">				writeHandle(h);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">				writeClass((Class) obj, unshared);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> ObjectStreamClass) &#123;</span><br><span class="line">				writeClassDesc((ObjectStreamClass) obj, unshared);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// remaining cases</span></span><br><span class="line">		<span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;<span class="comment">// 如果对象是个String的类型，直接将String写出去就可以了</span></span><br><span class="line">			writeString((String) obj, unshared);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (cl.isArray()) &#123;</span><br><span class="line">			writeArray(obj, desc, unshared);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Enum) &#123;</span><br><span class="line">			writeEnum((Enum&lt;?&gt;) obj, desc, unshared);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Serializable) &#123;</span><br><span class="line">			writeOrdinaryObject(obj, desc, unshared);<span class="comment">// 将Object写入输出流</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> NotSerializableException(</span><br><span class="line">					cl.getName() + <span class="string">"\n"</span> + debugInfoStack.toString());</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> NotSerializableException(cl.getName());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		depth--;</span><br><span class="line">		bout.setBlockDataMode(oldMode);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查找class的ObjectStreamClass对象描述信息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ObjectStreamClass <span class="title">lookup</span><span class="params">(Class&lt;?&gt; cl, <span class="keyword">boolean</span> all)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(all || Serializable.class.isAssignableFrom(cl))) &#123;<span class="comment">// 如果Object可以被序列化</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	processQueue(Caches.localDescsQueue, Caches.localDescs);<span class="comment">// 一个是引用队列      一个是集合Map&lt;WeakClassKey&lt;class&gt;,SoftReference&lt;EntryFuture&gt;&gt;，  引用队列里保存的就是这个Map集合的Key  ，将所有失效的引用删除，以及map中的保存的SoftReference&lt;EntryFuture&gt;  value删除</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">private static final ReferenceQueue&lt;Class&lt;?&gt;&gt; localDescsQueue = new ReferenceQueue&lt;&gt;();// 引用队列</span></span><br><span class="line"><span class="comment">static final ConcurrentMap&lt;WeakClassKey,Reference&lt;?&gt;&gt; localDescs = new ConcurrentHashMap&lt;&gt;();// 弱引用以及引用队列</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">static void processQueue(ReferenceQueue&lt;Class&lt;?&gt;&gt; queue,ConcurrentMap&lt;? extends WeakReference&lt;Class&lt;?&gt;&gt;, ?&gt; map)&#123;</span></span><br><span class="line"><span class="comment">	Reference&lt;? extends Class&lt;?&gt;&gt; ref;</span></span><br><span class="line"><span class="comment">	while((ref = queue.poll()) != null) &#123;// 从引用队列中拿出已经被删除的引用，然后从map中清除对应的value值</span></span><br><span class="line"><span class="comment">		map.remove(ref);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 这里的class对应的是WeakClassKey（class）， 里面持有的是class的hash值</span></span><br><span class="line">	<span class="comment">// 下面的Field对应的是FieldReflectorKey（class）， 也是WeakReference&lt;Class&gt;类型, 里面持有的是fieldName, fieldSignature</span></span><br><span class="line">	WeakClassKey key = <span class="keyword">new</span> WeakClassKey(cl, Caches.localDescsQueue);</span><br><span class="line"><span class="comment">/*static class WeakClassKey extends WeakReference&lt;Class&lt;?&gt;&gt; &#123;</span></span><br><span class="line"><span class="comment">	private final int hash;</span></span><br><span class="line"><span class="comment">	WeakClassKey(Class&lt;?&gt; cl, ReferenceQueue&lt;Class&lt;?&gt;&gt; refQueue) &#123;</span></span><br><span class="line"><span class="comment">		super(cl, refQueue);// 将这个Object的Class对象的弱引用与引用队列关联</span></span><br><span class="line"><span class="comment">		hash = System.identityHashCode(cl);// 将这个Class对象的hashCode保存起来</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">	Reference&lt;?&gt; ref = Caches.localDescs.get(key);<span class="comment">// 从map中通过这个WeakClassKey获取SoftReference&lt;EntryFuture&gt;</span></span><br><span class="line">	Object entry = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;<span class="comment">// 如果能拿到SoftReference&lt;EntryFuture&gt;值出来</span></span><br><span class="line">		entry = ref.get();</span><br><span class="line">	&#125;</span><br><span class="line">	EntryFuture future = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;<span class="comment">// 如果前面没有拿到对应的EntryFuture</span></span><br><span class="line">		EntryFuture newEntry = <span class="keyword">new</span> EntryFuture();<span class="comment">// 自己创建一个EntryFuture</span></span><br><span class="line">		Reference&lt;?&gt; newRef = <span class="keyword">new</span> SoftReference&lt;&gt;(newEntry);<span class="comment">// 再使用软引用将这个EntryFuture包装起来</span></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;<span class="comment">// 如果软引用不为null，将其从map中删除掉</span></span><br><span class="line">				Caches.localDescs.remove(key, ref);</span><br><span class="line">			&#125;</span><br><span class="line">			ref = Caches.localDescs.putIfAbsent(key, newRef);<span class="comment">// 将新的WeakClassKey和新的SoftReference(EntryFuture)放入map中</span></span><br><span class="line">			<span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;<span class="comment">// 如果map中有旧值，将旧值拿出来</span></span><br><span class="line">				entry = ref.get();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">while</span> (ref != <span class="keyword">null</span> &amp;&amp; entry == <span class="keyword">null</span>);<span class="comment">// 如果map中有旧的SoftReference(EntryFuture),其对应的EntryFuture还等于null，继续循环，将其删除，放入新的WeakClassKey(class)和新的SoftReference(newEntry)</span></span><br><span class="line">		<span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;<span class="comment">// 如果entry为null，将新的EntryFuture赋值给变量future，以供下面使用</span></span><br><span class="line">			future = newEntry;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (entry <span class="keyword">instanceof</span> ObjectStreamClass) &#123;  <span class="comment">// check common case first</span></span><br><span class="line">		<span class="keyword">return</span> (ObjectStreamClass) entry;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (entry <span class="keyword">instanceof</span> EntryFuture) &#123;</span><br><span class="line">		future = (EntryFuture) entry;</span><br><span class="line">		<span class="keyword">if</span> (future.getOwner() == Thread.currentThread()) &#123;</span><br><span class="line">			entry = <span class="keyword">null</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			entry = future.get();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;<span class="comment">// 如果entry为null，现在这个Entry就是个null值，得创建一份出来，然后放入EntryFuture中</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			entry = <span class="keyword">new</span> ObjectStreamClass(cl);<span class="comment">// 创建一个ObjectStreamClass(class)对象，当做Entry，需要放入EntryFuture中，并且需要将WeakClassKey(class)当key，SoftReference(EntryFuture&lt;ObjectStreamClass&gt;)当value保存到map中</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">			entry = th;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (future.set(entry)) &#123;<span class="comment">// 将该强引用放入future中</span></span><br><span class="line">			Caches.localDescs.put(key, <span class="keyword">new</span> SoftReference&lt;Object&gt;(entry));<span class="comment">// 将ObjectStreamClass用一个软引用包起来，保存到key是WeakClassKey(class)的map中</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			entry = future.get();<span class="comment">// 如果放入失败，从future中拿出那个强引用</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (entry <span class="keyword">instanceof</span> ObjectStreamClass) &#123;</span><br><span class="line">		<span class="keyword">return</span> (ObjectStreamClass) entry;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">		<span class="keyword">throw</span> (RuntimeException) entry;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">		<span class="keyword">throw</span> (Error) entry;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"unexpected entry: "</span> + entry);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>new ObjectStreamClass(Class)时候的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ObjectStreamClass</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; cl)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.cl = cl; <span class="comment">// 将class类型保存到cl字段上</span></span><br><span class="line">	name = cl.getName();<span class="comment">// 将类型名称保存到name字段上</span></span><br><span class="line">	isProxy = Proxy.isProxyClass(cl);<span class="comment">// 将是否是代理类保存到isProxy字段上</span></span><br><span class="line">	isEnum = Enum.class.isAssignableFrom(cl);<span class="comment">// 将是否是枚举保存到isEnum字段上</span></span><br><span class="line">	serializable = Serializable.class.isAssignableFrom(cl);<span class="comment">// 将是否可以序列化保存到serializable字段上</span></span><br><span class="line">	externalizable = Externalizable.class.isAssignableFrom(cl);<span class="comment">// 将是否是自定义序列化保存到externalizable字段上</span></span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; superCl = cl.getSuperclass();<span class="comment">// 拿到这个class的父类class</span></span><br><span class="line">	superDesc = (superCl != <span class="keyword">null</span>) ? lookup(superCl, <span class="keyword">false</span>) : <span class="keyword">null</span>;<span class="comment">// 将父类对象class描述保存到superDesc字段上</span></span><br><span class="line">	localDesc = <span class="keyword">this</span>;<span class="comment">// 将本对象class描述保存到localDesc字段上</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (serializable) &#123; <span class="comment">// 如果是可序列化类型的对象</span></span><br><span class="line">		AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;<span class="comment">// 使用特权处理本类中的构造函数及属性字段</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (isEnum) &#123;</span><br><span class="line">					suid = Long.valueOf(<span class="number">0</span>);</span><br><span class="line">					fields = NO_FIELDS;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (cl.isArray()) &#123;</span><br><span class="line">					fields = NO_FIELDS;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				suid = getDeclaredSUID(cl);<span class="comment">// 获取class保存着的静态的、final的版本号</span></span><br><span class="line"><span class="comment">/*private static Long getDeclaredSUID(Class&lt;?&gt; cl) &#123;</span></span><br><span class="line"><span class="comment">	try &#123;</span></span><br><span class="line"><span class="comment">		Field f = cl.getDeclaredField("serialVersionUID");//3206093459760846163L</span></span><br><span class="line"><span class="comment">		int mask = Modifier.STATIC | Modifier.FINAL;</span></span><br><span class="line"><span class="comment">		if ((f.getModifiers() &amp; mask) == mask) &#123;</span></span><br><span class="line"><span class="comment">			f.setAccessible(true);</span></span><br><span class="line"><span class="comment">			return Long.valueOf(f.getLong(null));</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125; catch (Exception ex) &#123;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	return null;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					fields = getSerialFields(cl);<span class="comment">// 获取可序列化的属性字段</span></span><br><span class="line"><span class="comment">/*private static ObjectStreamField[] getSerialFields(Class&lt;?&gt; cl) throws InvalidClassException&#123;</span></span><br><span class="line"><span class="comment">	ObjectStreamField[] fields;</span></span><br><span class="line"><span class="comment">	if (Serializable.class.isAssignableFrom(cl) &amp;&amp; //还得校验一遍class类型是不是可序列化的、不能是代理类、不能是接口</span></span><br><span class="line"><span class="comment">		!Externalizable.class.isAssignableFrom(cl) &amp;&amp;</span></span><br><span class="line"><span class="comment">		!Proxy.isProxyClass(cl) &amp;&amp;</span></span><br><span class="line"><span class="comment">		!cl.isInterface())&#123;</span></span><br><span class="line"><span class="comment">		if ((fields = getDeclaredSerialFields(cl)) == null) &#123;// 看看有没有自定义自己配置的可序列化的字段，字段名必须是serialPersistentFields，类型是ObjectStreamField[]数组类型</span></span><br><span class="line"><span class="comment">			fields = getDefaultSerialFields(cl);// 如果自己没有自定义自配置可序列化字段，那就按正常逻辑走了</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		Arrays.sort(fields);// 对这些属性字段定义（ObjectStreamField）进行排序</span></span><br><span class="line"><span class="comment">	&#125; else &#123;</span></span><br><span class="line"><span class="comment">		fields = NO_FIELDS;// 如果实现的是Externalizable，fields是空的</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	return fields;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">// 查找自己定义的可序列化字段===serialPersistentFields</span></span><br><span class="line"><span class="comment">private static ObjectStreamField[] getDeclaredSerialFields(Class&lt;?&gt; cl) throws InvalidClassException&#123;// ObjectStreamClass中的</span></span><br><span class="line"><span class="comment">	ObjectStreamField[] serialPersistentFields = null;// 查找序列化编号字段</span></span><br><span class="line"><span class="comment">	try &#123;</span></span><br><span class="line"><span class="comment">		Field f = cl.getDeclaredField("serialPersistentFields");// 尝试拿到serialPersistentFields字段，这个字段必须是private、static、final修饰的</span></span><br><span class="line"><span class="comment">		int mask = Modifier.PRIVATE | Modifier.STATIC | Modifier.FINAL;</span></span><br><span class="line"><span class="comment">		if ((f.getModifiers() &amp; mask) == mask) &#123;</span></span><br><span class="line"><span class="comment">			f.setAccessible(true);</span></span><br><span class="line"><span class="comment">			serialPersistentFields = (ObjectStreamField[]) f.get(null);</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125; catch (Exception ex) &#123;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	if (serialPersistentFields == null) &#123;</span></span><br><span class="line"><span class="comment">		return null;</span></span><br><span class="line"><span class="comment">	&#125; else if (serialPersistentFields.length == 0) &#123;</span></span><br><span class="line"><span class="comment">		return NO_FIELDS;// 没有字段可序列化</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	// 如果拿到了这么一个字段，并且拿到了其里面配置的ObjectStreamField[]数组对象</span></span><br><span class="line"><span class="comment">	ObjectStreamField[] boundFields = new ObjectStreamField[serialPersistentFields.length];// 创建一个数组，用于保存在Object中真实存在的这些配置的属性字段</span></span><br><span class="line"><span class="comment">	Set&lt;String&gt; fieldNames = new HashSet&lt;&gt;(serialPersistentFields.length);// 定义一个集合</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; serialPersistentFields.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		ObjectStreamField spf = serialPersistentFields[i];// 获取第i个ObjectStreamField配置项</span></span><br><span class="line"><span class="comment">		String fname = spf.getName();</span></span><br><span class="line"><span class="comment">		if (fieldNames.contains(fname)) &#123;// 名字不能配置重复</span></span><br><span class="line"><span class="comment">			throw new InvalidClassException(</span></span><br><span class="line"><span class="comment">				"multiple serializable fields named " + fname);</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		fieldNames.add(fname);// 将名字放入fieldNames集合中</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">		try &#123;</span></span><br><span class="line"><span class="comment">			Field f = cl.getDeclaredField(fname);// 根据名字再去class中看有没有这个字段属性</span></span><br><span class="line"><span class="comment">			if ((f.getType() == spf.getType()) &amp;&amp; ((f.getModifiers() &amp; Modifier.STATIC) == 0))&#123;// 如果拿到的字段属性跟配置的字段属性一样，并且不是static修饰的</span></span><br><span class="line"><span class="comment">				boundFields[i] = new ObjectStreamField(f, spf.isUnshared(), true);// 这里才是真正的封装一个ObjectStreamField</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125; catch (NoSuchFieldException ex) &#123;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		if (boundFields[i] == null) &#123; // 如果从class中拿不到配置中的属性字段，也封装一个配置的属性名称及属性类型的ObjectStreamField对象</span></span><br><span class="line"><span class="comment">			boundFields[i] = new ObjectStreamField(fname, spf.getType(), spf.isUnshared());</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	return boundFields;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">public Field getDeclaredField(String name) throws NoSuchFieldException, SecurityException &#123;// 从class中查找定义的属性字段</span></span><br><span class="line"><span class="comment">	checkMemberAccess(Member.DECLARED, Reflection.getCallerClass(), true);// 校验是否有查看该class的权限</span></span><br><span class="line"><span class="comment">	Field field = searchFields(privateGetDeclaredFields(false), name);// 查找对应的field</span></span><br><span class="line"><span class="comment">	if (field == null) &#123;</span></span><br><span class="line"><span class="comment">		throw new NoSuchFieldException(name);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	return field;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">private void checkMemberAccess(int which, Class&lt;?&gt; caller, boolean checkProxyInterfaces) &#123;// 校验是否有查看该class的权限</span></span><br><span class="line"><span class="comment">	final SecurityManager s = System.getSecurityManager();// 权限管理，现在为null</span></span><br><span class="line"><span class="comment">	if (s != null) &#123;</span></span><br><span class="line"><span class="comment">		final ClassLoader ccl = ClassLoader.getClassLoader(caller);</span></span><br><span class="line"><span class="comment">		final ClassLoader cl = getClassLoader0();</span></span><br><span class="line"><span class="comment">		if (which != Member.PUBLIC) &#123;</span></span><br><span class="line"><span class="comment">			if (ccl != cl) &#123;</span></span><br><span class="line"><span class="comment">				s.checkPermission(SecurityConstants.CHECK_MEMBER_ACCESS_PERMISSION);</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		this.checkPackageAccess(ccl, checkProxyInterfaces);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">private Field[] privateGetDeclaredFields(boolean publicOnly) &#123;// 该class所有的属性字段定义，不仅仅是public修饰的</span></span><br><span class="line"><span class="comment">	checkInitted();</span></span><br><span class="line"><span class="comment">	Field[] res;</span></span><br><span class="line"><span class="comment">	ReflectionData&lt;T&gt; rd = reflectionData();</span></span><br><span class="line"><span class="comment">	if (rd != null) &#123;</span></span><br><span class="line"><span class="comment">		res = publicOnly ? rd.declaredPublicFields : rd.declaredFields;// declaredFields是所有的属性字段，不仅仅是public的</span></span><br><span class="line"><span class="comment">		if (res != null) return res; </span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	// No cached value available; request value from VM</span></span><br><span class="line"><span class="comment">	res = Reflection.filterFields(this, getDeclaredFields0(publicOnly));</span></span><br><span class="line"><span class="comment">	if (rd != null) &#123;</span></span><br><span class="line"><span class="comment">		if (publicOnly) &#123;</span></span><br><span class="line"><span class="comment">			rd.declaredPublicFields = res;</span></span><br><span class="line"><span class="comment">		&#125; else &#123;</span></span><br><span class="line"><span class="comment">			rd.declaredFields = res;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	return res;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">private ReflectionData&lt;T&gt; reflectionData() &#123;// 从Class对象的的reflectionData属性字段（SoftReference）中获取反射数据</span></span><br><span class="line"><span class="comment">	SoftReference&lt;ReflectionData&lt;T&gt;&gt; reflectionData = this.reflectionData;</span></span><br><span class="line"><span class="comment">	int classRedefinedCount = this.classRedefinedCount;</span></span><br><span class="line"><span class="comment">	ReflectionData&lt;T&gt; rd;</span></span><br><span class="line"><span class="comment">	if (useCaches &amp;&amp;</span></span><br><span class="line"><span class="comment">		reflectionData != null &amp;&amp;</span></span><br><span class="line"><span class="comment">		(rd = reflectionData.get()) != null &amp;&amp;</span></span><br><span class="line"><span class="comment">		rd.redefinedCount == classRedefinedCount) &#123;</span></span><br><span class="line"><span class="comment">		return rd;// 将缓存中的反射数据返回</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	return newReflectionData(reflectionData, classRedefinedCount);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">private static Field searchFields(Field[] fields, String name) &#123;// 既然拿到了所有的属性字段定义，一个一个比较名字就可以了，如果名字相同，返回</span></span><br><span class="line"><span class="comment">	String internedName = name.intern();</span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; fields.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		if (fields[i].getName() == internedName) &#123;</span></span><br><span class="line"><span class="comment">			return getReflectionFactory().copyField(fields[i]);</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	return null;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">public Field copyField(Field var1) &#123;</span></span><br><span class="line"><span class="comment">	return langReflectAccess().copyField(var1);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">Field copy() &#123;// 拷贝一个Field对象</span></span><br><span class="line"><span class="comment">	if (this.root != null) throw new IllegalArgumentException("Can not copy a non-root Field");</span></span><br><span class="line"><span class="comment">	Field res = new Field(clazz, name, type, modifiers, slot, signature, annotations);</span></span><br><span class="line"><span class="comment">	res.root = this;</span></span><br><span class="line"><span class="comment">	res.fieldAccessor = fieldAccessor;</span></span><br><span class="line"><span class="comment">	res.overrideFieldAccessor = overrideFieldAccessor;</span></span><br><span class="line"><span class="comment">	return res;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">// 如果没有配置serialPersistentFields，那就需要自己去遍历Class的字段属性了</span></span><br><span class="line"><span class="comment">private static ObjectStreamField[] getDefaultSerialFields(Class&lt;?&gt; cl) &#123;</span></span><br><span class="line"><span class="comment">	Field[] clFields = cl.getDeclaredFields();// 拿到class中的属性字段</span></span><br><span class="line"><span class="comment">	ArrayList&lt;ObjectStreamField&gt; list = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">	int mask = Modifier.STATIC | Modifier.TRANSIENT;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; clFields.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		if ((clFields[i].getModifiers() &amp; mask) == 0) &#123;// 将静态字段和transient修饰的字段过滤</span></span><br><span class="line"><span class="comment">			list.add(new ObjectStreamField(clFields[i], false, true));// 将字段包装成ObjectStreamField类型</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	int size = list.size();</span></span><br><span class="line"><span class="comment">	return (size == 0) ? NO_FIELDS : list.toArray(new ObjectStreamField[size]);</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">					computeFieldOffsets();<span class="comment">// 计算便宜量，及字段属性数量</span></span><br><span class="line"><span class="comment">/*private void computeFieldOffsets() throws InvalidClassException &#123;</span></span><br><span class="line"><span class="comment">	primDataSize = 0;</span></span><br><span class="line"><span class="comment">	numObjFields = 0;</span></span><br><span class="line"><span class="comment">	int firstObjIndex = -1;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; fields.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		ObjectStreamField f = fields[i];</span></span><br><span class="line"><span class="comment">		switch (f.getTypeCode()) &#123;</span></span><br><span class="line"><span class="comment">			case 'Z':</span></span><br><span class="line"><span class="comment">			case 'B':</span></span><br><span class="line"><span class="comment">				f.setOffset(primDataSize++);// 设置原始数据偏移量</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			case 'C':</span></span><br><span class="line"><span class="comment">			case 'S':</span></span><br><span class="line"><span class="comment">				f.setOffset(primDataSize);// 设置原始数据偏移量</span></span><br><span class="line"><span class="comment">				primDataSize += 2;// 记录原始数据字节数</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			case 'I':</span></span><br><span class="line"><span class="comment">			case 'F':</span></span><br><span class="line"><span class="comment">				f.setOffset(primDataSize);// 设置原始数据偏移量</span></span><br><span class="line"><span class="comment">				primDataSize += 4;// 记录原始数据字节数</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			case 'J':</span></span><br><span class="line"><span class="comment">			case 'D':</span></span><br><span class="line"><span class="comment">				f.setOffset(primDataSize);// 设置原始数据偏移量</span></span><br><span class="line"><span class="comment">				primDataSize += 8;// 记录原始数据字节数</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			case '[':</span></span><br><span class="line"><span class="comment">			case 'L':</span></span><br><span class="line"><span class="comment">				f.setOffset(numObjFields++);// 设置这是第几个非原始属性字段</span></span><br><span class="line"><span class="comment">				if (firstObjIndex == -1) &#123;</span></span><br><span class="line"><span class="comment">					firstObjIndex = i;</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			default:</span></span><br><span class="line"><span class="comment">				throw new InternalError();</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	if (firstObjIndex != -1 &amp;&amp; firstObjIndex + numObjFields != fields.length)&#123;</span></span><br><span class="line"><span class="comment">		throw new InvalidClassException(name, "illegal field order");</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">				&#125; <span class="keyword">catch</span> (InvalidClassException e) &#123;</span><br><span class="line">					serializeEx = deserializeEx = <span class="keyword">new</span> ExceptionInfo(e.classname, e.getMessage());</span><br><span class="line">					fields = NO_FIELDS;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (externalizable) &#123;</span><br><span class="line">					cons = getExternalizableConstructor(cl);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					cons = getSerializableConstructor(cl);<span class="comment">// 将class对象的无参构造函数保存到cons变量</span></span><br><span class="line"><span class="comment">/*private static Constructor&lt;?&gt; getSerializableConstructor(Class&lt;?&gt; cl) &#123;</span></span><br><span class="line"><span class="comment">	Class&lt;?&gt; initCl = cl;</span></span><br><span class="line"><span class="comment">	while (Serializable.class.isAssignableFrom(initCl)) &#123;// 查找不可序列化的父类</span></span><br><span class="line"><span class="comment">		if ((initCl = initCl.getSuperclass()) == null) &#123;</span></span><br><span class="line"><span class="comment">			return null;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	try &#123;</span></span><br><span class="line"><span class="comment">		Constructor&lt;?&gt; cons = initCl.getDeclaredConstructor((Class&lt;?&gt;[]) null);// 拿到不可序列化的父类的无参构造函数</span></span><br><span class="line"><span class="comment">		int mods = cons.getModifiers();</span></span><br><span class="line"><span class="comment">		if ((mods &amp; Modifier.PRIVATE) != 0 || // 校验不可序列化的父类无参构造函数，不能是私有的，必须是public或protected类型，包必须有访问权限</span></span><br><span class="line"><span class="comment">			((mods &amp; (Modifier.PUBLIC | Modifier.PROTECTED)) == 0 &amp;&amp; </span></span><br><span class="line"><span class="comment">			 !packageEquals(cl, initCl)))&#123;</span></span><br><span class="line"><span class="comment">			return null;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		cons = reflFactory.newConstructorForSerialization(cl, cons);// 创建一个新的构造方法</span></span><br><span class="line"><span class="comment">		cons.setAccessible(true);</span></span><br><span class="line"><span class="comment">		return cons;</span></span><br><span class="line"><span class="comment">	&#125; catch (NoSuchMethodException ex) &#123;</span></span><br><span class="line"><span class="comment">		return null;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">					writeObjectMethod = getPrivateMethod(cl, <span class="string">"writeObject"</span>,	<span class="keyword">new</span> Class&lt;?&gt;[] &#123; ObjectOutputStream.class &#125;,Void.TYPE);<span class="comment">// 将writeObject方法保存到writeObjectMethod属性字段上</span></span><br><span class="line">					readObjectMethod = getPrivateMethod(cl, <span class="string">"readObject"</span>,<span class="keyword">new</span> Class&lt;?&gt;[] &#123; ObjectInputStream.class &#125;,Void.TYPE);<span class="comment">// 将readObject方法保存到readObjectMethod属性字段上</span></span><br><span class="line">					readObjectNoDataMethod = getPrivateMethod(cl, <span class="string">"readObjectNoData"</span>, <span class="keyword">null</span>, Void.TYPE);<span class="comment">// 将readObjectNoData方法保存到readObjectNoDataMethod属性字段上</span></span><br><span class="line"><span class="comment">/*private static Method getPrivateMethod(Class&lt;?&gt; cl, String name,Class&lt;?&gt;[] argTypes,Class&lt;?&gt; returnType)&#123;// 收集当前class的私有方法</span></span><br><span class="line"><span class="comment">	try &#123;</span></span><br><span class="line"><span class="comment">		Method meth = cl.getDeclaredMethod(name, argTypes);</span></span><br><span class="line"><span class="comment">		meth.setAccessible(true);</span></span><br><span class="line"><span class="comment">		int mods = meth.getModifiers();</span></span><br><span class="line"><span class="comment">		return ((meth.getReturnType() == returnType) &amp;&amp;</span></span><br><span class="line"><span class="comment">				((mods &amp; Modifier.STATIC) == 0) &amp;&amp;</span></span><br><span class="line"><span class="comment">				((mods &amp; Modifier.PRIVATE) != 0)) ? meth : null;// 收集private类型的非static类型的方法</span></span><br><span class="line"><span class="comment">	&#125; catch (NoSuchMethodException ex) &#123;</span></span><br><span class="line"><span class="comment">		return null;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">					hasWriteObjectData = (writeObjectMethod != <span class="keyword">null</span>);<span class="comment">// 是否有其它需要持久化的数据</span></span><br><span class="line">				&#125;</span><br><span class="line">				writeReplaceMethod = getInheritableMethod(cl, <span class="string">"writeReplace"</span>, <span class="keyword">null</span>, Object.class);<span class="comment">// 将writeReplace方法收集起来（当前类或者父类）</span></span><br><span class="line">				readResolveMethod = getInheritableMethod(cl, <span class="string">"readResolve"</span>, <span class="keyword">null</span>, Object.class);<span class="comment">// 将readResolve方法收集起来（当前类或者父类）</span></span><br><span class="line"><span class="comment">/*private static Method getInheritableMethod(Class&lt;?&gt; cl, String name,Class&lt;?&gt;[] argTypes, Class&lt;?&gt; returnType)&#123;// 收集自己（私有/公有，非静态）或父类（非静态、非私有）里的方法</span></span><br><span class="line"><span class="comment">	Method meth = null;</span></span><br><span class="line"><span class="comment">	Class&lt;?&gt; defCl = cl;</span></span><br><span class="line"><span class="comment">	while (defCl != null) &#123;</span></span><br><span class="line"><span class="comment">		try &#123;</span></span><br><span class="line"><span class="comment">			meth = defCl.getDeclaredMethod(name, argTypes);</span></span><br><span class="line"><span class="comment">			break;</span></span><br><span class="line"><span class="comment">		&#125; catch (NoSuchMethodException ex) &#123;</span></span><br><span class="line"><span class="comment">			defCl = defCl.getSuperclass();</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	if ((meth == null) || (meth.getReturnType() != returnType)) &#123;</span></span><br><span class="line"><span class="comment">		return null;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	meth.setAccessible(true);</span></span><br><span class="line"><span class="comment">	int mods = meth.getModifiers();</span></span><br><span class="line"><span class="comment">	if ((mods &amp; (Modifier.STATIC | Modifier.ABSTRACT)) != 0) &#123;</span></span><br><span class="line"><span class="comment">		return null;</span></span><br><span class="line"><span class="comment">	&#125; else if ((mods &amp; (Modifier.PUBLIC | Modifier.PROTECTED)) != 0) &#123;</span></span><br><span class="line"><span class="comment">		return meth;</span></span><br><span class="line"><span class="comment">	&#125; else if ((mods &amp; Modifier.PRIVATE) != 0) &#123;</span></span><br><span class="line"><span class="comment">		return (cl == defCl) ? meth : null;</span></span><br><span class="line"><span class="comment">	&#125; else &#123;</span></span><br><span class="line"><span class="comment">		return packageEquals(cl, defCl) ? meth : null;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		suid = Long.valueOf(<span class="number">0</span>);</span><br><span class="line">		fields = NO_FIELDS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		fieldRefl = getReflector(fields, <span class="keyword">this</span>);<span class="comment">// 处理收集到的ObjectStreamField数组，将其转换成FieldReflactor对象，保存到fieldRefl属性字段上</span></span><br><span class="line">	&#125; <span class="keyword">catch</span> (InvalidClassException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InternalError(ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (deserializeEx == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (isEnum) &#123;</span><br><span class="line">			deserializeEx = <span class="keyword">new</span> ExceptionInfo(name, <span class="string">"enum type"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (cons == <span class="keyword">null</span>) &#123;</span><br><span class="line">			deserializeEx = <span class="keyword">new</span> ExceptionInfo(name, <span class="string">"no valid constructor"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (fields[i].getField() == <span class="keyword">null</span>) &#123;</span><br><span class="line">			defaultSerializeEx = <span class="keyword">new</span> ExceptionInfo(name, <span class="string">"unmatched serializable field(s) declared"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>获取ObjectStreamClass中的FieldReflector对象的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> FieldReflector <span class="title">getReflector</span><span class="params">(ObjectStreamField[] fields, ObjectStreamClass localDesc)</span> <span class="keyword">throws</span> InvalidClassException</span>&#123;</span><br><span class="line">	Class&lt;?&gt; cl = (localDesc != <span class="keyword">null</span> &amp;&amp; fields.length &gt; <span class="number">0</span>) ? localDesc.cl : <span class="keyword">null</span>;<span class="comment">// 拿到要序列化对象的Class</span></span><br><span class="line">	processQueue(Caches.reflectorsQueue, Caches.reflectors);<span class="comment">// 清理引用队列中无效的引用（FieldReflectorKey(class,queue)&lt;=&gt;WeakReference(class)，也就是说Class对象被回收了），并将reflectors Map中对应的弱引用删除（key=FieldReflectorKey,value为弱引用SoftReference&lt;EntryFuture&gt;）</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 上面的class对应的是WeakClassKey（class）， 里面持有的是class的hash值</span></span><br><span class="line">	<span class="comment">// 这里的Field对应的是FieldReflectorKey（class）， 也是WeakReference&lt;Class&gt;类型, 里面持有的是fieldName, fieldSignature</span></span><br><span class="line">	FieldReflectorKey key = <span class="keyword">new</span> FieldReflectorKey(cl, fields, Caches.reflectorsQueue);</span><br><span class="line">	</span><br><span class="line">	Reference&lt;?&gt; ref = Caches.reflectors.get(key);<span class="comment">// 如果在map中保存有这个FieldReflectorKey，将其对应的Value拿出来，Value就是一个对象软引用（SoftReference&lt;EntryFuture&gt;）</span></span><br><span class="line">	Object entry = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">		entry = ref.get();<span class="comment">// 如果能使用新创建的FieldReflectorKey当做key从map中吧SoftReference&lt;EntryFuture&gt;拿出来，怎么可能？</span></span><br><span class="line">	&#125;</span><br><span class="line">	EntryFuture future = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">		EntryFuture newEntry = <span class="keyword">new</span> EntryFuture();</span><br><span class="line">		Reference&lt;?&gt; newRef = <span class="keyword">new</span> SoftReference&lt;&gt;(newEntry);<span class="comment">// 给新创建的EntryFuture分配一个软引用</span></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;<span class="comment">// 如果之前就有FieldReflectorKey，并且有其对应的EntryFuture的软引用，但是软引用中的EntryFuture拿不到，那就将它从map集合中删除掉</span></span><br><span class="line">				Caches.reflectors.remove(key, ref);</span><br><span class="line">			&#125;</span><br><span class="line">			ref = Caches.reflectors.putIfAbsent(key, newRef);<span class="comment">// 我们再把新的FieldReflectorKey及对应的软引用保存到map中去</span></span><br><span class="line">			<span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">				entry = ref.get();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">while</span> (ref != <span class="keyword">null</span> &amp;&amp; entry == <span class="keyword">null</span>);<span class="comment">// 如果旧的软引用存在，但是里面的EntryFuture是null的，一直循环处理</span></span><br><span class="line">		<span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;<span class="comment">// 如果entry还是空的，将EntryFuture赋值，然后下面会将处理过的Entry放入EntryFuture中保存起来</span></span><br><span class="line">			future = newEntry;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (entry <span class="keyword">instanceof</span> FieldReflector) &#123;  <span class="comment">// check common case first</span></span><br><span class="line">		<span class="keyword">return</span> (FieldReflector) entry;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry <span class="keyword">instanceof</span> EntryFuture) &#123;</span><br><span class="line">		entry = ((EntryFuture) entry).get();</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			entry = <span class="keyword">new</span> FieldReflector(matchFields(fields, localDesc));<span class="comment">// 真正创建FieldReflactor对象， 上面class创建的是ObjectStreamClass对象,为啥这里不是创建的额ObjectStreamField对象？</span></span><br><span class="line"><span class="comment">/*private static ObjectStreamField[] matchFields(ObjectStreamField[] fields,ObjectStreamClass localDesc) throws InvalidClassException&#123; // 传进来的Fields不就是ObjectStreamClass中的fields字段吗，这还匹配个啥？</span></span><br><span class="line"><span class="comment">	ObjectStreamField[] localFields = (localDesc != null) ?	localDesc.fields : NO_FIELDS;// 拿到所有的fields</span></span><br><span class="line"><span class="comment">	ObjectStreamField[] matches = new ObjectStreamField[fields.length];</span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; fields.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		ObjectStreamField f = fields[i], m = null;// 拿到传进来的ObjectStreamField[i]</span></span><br><span class="line"><span class="comment">		for (int j = 0; j &lt; localFields.length; j++) &#123;</span></span><br><span class="line"><span class="comment">			ObjectStreamField lf = localFields[j];// 拿到ObjectStreamClass中的fields[j]</span></span><br><span class="line"><span class="comment">			if (f.getName().equals(lf.getName())) &#123;// 如果字段名相等</span></span><br><span class="line"><span class="comment">				if ((f.isPrimitive() || lf.isPrimitive()) &amp;&amp; // 如果是原始类型，并且类型不一致，抛出异常</span></span><br><span class="line"><span class="comment">					f.getTypeCode() != lf.getTypeCode())&#123;</span></span><br><span class="line"><span class="comment">					throw new InvalidClassException(localDesc.name,"incompatible types for field " + f.getName());</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">				if (lf.getField() != null) &#123;</span></span><br><span class="line"><span class="comment">					m = new ObjectStreamField(lf.getField(), lf.isUnshared(), false);</span></span><br><span class="line"><span class="comment">				&#125; else &#123;</span></span><br><span class="line"><span class="comment">					m = new ObjectStreamField(lf.getName(), lf.getSignature(), lf.isUnshared());</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		if (m == null) &#123;// 如果与ObjectStreamClass中的fields匹配不成功，就再创建一个ObjectStreamField，这怎么会匹配不成功，不都是同一个数组引用吗？</span></span><br><span class="line"><span class="comment">			m = new ObjectStreamField(f.getName(), f.getSignature(), false);</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		m.setOffset(f.getOffset());// 设置偏移量</span></span><br><span class="line"><span class="comment">		matches[i] = m;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	return matches;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">FieldReflector(ObjectStreamField[] fields) &#123;// 将匹配成功的fields放入FieldReflector中保存起来</span></span><br><span class="line"><span class="comment">	this.fields = fields; // 保存fields引用</span></span><br><span class="line"><span class="comment">	int nfields = fields.length;// 保存fields数组长度</span></span><br><span class="line"><span class="comment">	readKeys = new long[nfields];// 属性字段的内存偏移量</span></span><br><span class="line"><span class="comment">	writeKeys = new long[nfields];// 属性字段的内存偏移量</span></span><br><span class="line"><span class="comment">	offsets = new int[nfields]; // 原始数据类型属性字段的字节数组下标，非原始数据类型属性字段的第几个（从0开始）非原始数据类型属性字段</span></span><br><span class="line"><span class="comment">	typeCodes = new char[nfields]; // 创建字段属性类型的数组</span></span><br><span class="line"><span class="comment">	ArrayList&lt;Class&lt;?&gt;&gt; typeList = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">	Set&lt;Long&gt; usedKeys = new HashSet&lt;&gt;();</span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; nfields; i++) &#123;</span></span><br><span class="line"><span class="comment">		ObjectStreamField f = fields[i];</span></span><br><span class="line"><span class="comment">		Field rf = f.getField();// 从ObjectStreamField中拿出Field对象出来</span></span><br><span class="line"><span class="comment">		long key = (rf != null) ? unsafe.objectFieldOffset(rf) : Unsafe.INVALID_FIELD_OFFSET;// 计算字段在class中的偏移量</span></span><br><span class="line"><span class="comment">		readKeys[i] = key;// 保存属性字段在class中的偏移量</span></span><br><span class="line"><span class="comment">		writeKeys[i] = usedKeys.add(key) ?	key : Unsafe.INVALID_FIELD_OFFSET;// 去重字段属性在class中的偏移量，并将偏移量写入writeKeys数组中</span></span><br><span class="line"><span class="comment">		offsets[i] = f.getOffset();// 将原始类型字段的偏移量或第几个非原始类型属性字段保存到offsets中</span></span><br><span class="line"><span class="comment">		typeCodes[i] = f.getTypeCode();// 保存属性字段的类型</span></span><br><span class="line"><span class="comment">		if (!f.isPrimitive()) &#123;// 如果不是原始类型的属性字段，将属性字段的类型保存到typeList集合中</span></span><br><span class="line"><span class="comment">			typeList.add((rf != null) ? rf.getType() : null);</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	types = typeList.toArray(new Class&lt;?&gt;[typeList.size()]);// 将非原始类型的属性字段的class类型保存到数组types中</span></span><br><span class="line"><span class="comment">	numPrimFields = nfields - types.length;// 将原始类型的属性字段数量保存到numPrimFields中</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">			entry = th;</span><br><span class="line">		&#125;</span><br><span class="line">		future.set(entry);</span><br><span class="line">		Caches.reflectors.put(key, <span class="keyword">new</span> SoftReference&lt;Object&gt;(entry));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (entry <span class="keyword">instanceof</span> FieldReflector) &#123;</span><br><span class="line">		<span class="keyword">return</span> (FieldReflector) entry;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry <span class="keyword">instanceof</span> InvalidClassException) &#123;</span><br><span class="line">		<span class="keyword">throw</span> (InvalidClassException) entry;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">		<span class="keyword">throw</span> (RuntimeException) entry;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">		<span class="keyword">throw</span> (Error) entry;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"unexpected entry: "</span> + entry);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>开始写入Object序列化数据<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeOrdinaryObject</span><span class="params">(Object obj,ObjectStreamClass desc,<span class="keyword">boolean</span> unshared)</span><span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (extendedDebugInfo) &#123;<span class="comment">// debug</span></span><br><span class="line">		debugInfoStack.push(</span><br><span class="line">			(depth == <span class="number">1</span> ? <span class="string">"root "</span> : <span class="string">""</span>) + <span class="string">"object (class \""</span> +</span><br><span class="line">			obj.getClass().getName() + <span class="string">"\", "</span> + obj.toString() + <span class="string">")"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		desc.checkSerialize();<span class="comment">// 查看是否有序列化异常</span></span><br><span class="line"></span><br><span class="line">		bout.writeByte(TC_OBJECT);<span class="comment">// 开始序列化Object，将Object标志位写入，0x73;</span></span><br><span class="line">		writeClassDesc(desc, <span class="keyword">false</span>);<span class="comment">// 将描述信息写入</span></span><br><span class="line">		handles.assign(unshared ? <span class="keyword">null</span> : obj);</span><br><span class="line">		<span class="keyword">if</span> (desc.isExternalizable() &amp;&amp; !desc.isProxy()) &#123;</span><br><span class="line">			writeExternalData((Externalizable) obj);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			writeSerialData(obj, desc);<span class="comment">// 将Object的序列化的数据写入</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">			debugInfoStack.pop();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>写入ObjectStreamClass对象描述信息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeClassDesc</span><span class="params">(ObjectStreamClass desc, <span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">	<span class="keyword">int</span> handle;</span><br><span class="line">	<span class="keyword">if</span> (desc == <span class="keyword">null</span>) &#123;</span><br><span class="line">		writeNull();</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!unshared &amp;&amp; (handle = handles.lookup(desc)) != -<span class="number">1</span>) &#123;</span><br><span class="line">		writeHandle(handle);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (desc.isProxy()) &#123;</span><br><span class="line">		writeProxyDesc(desc, unshared);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		writeNonProxyDesc(desc, unshared);<span class="comment">// 写出非代理对象</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeNonProxyDesc</span><span class="params">(ObjectStreamClass desc, <span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">	bout.writeByte(TC_CLASSDESC);<span class="comment">// 开始写class的描述信息，先将标志位写入</span></span><br><span class="line">	handles.assign(unshared ? <span class="keyword">null</span> : desc);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (protocol == PROTOCOL_VERSION_1) &#123;</span><br><span class="line">		<span class="comment">// do not invoke class descriptor write hook with old protocol</span></span><br><span class="line">		desc.writeNonProxy(<span class="keyword">this</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果序列化版本不是1</span></span><br><span class="line">		writeClassDescriptor(desc);<span class="comment">// 类型描述</span></span><br><span class="line"><span class="comment">/*protected void writeClassDescriptor(ObjectStreamClass desc)	throws IOException&#123;</span></span><br><span class="line"><span class="comment">	desc.writeNonProxy(this);// 这里的this就是ObjectOutputStream</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">void writeNonProxy(ObjectOutputStream out) throws IOException &#123;</span></span><br><span class="line"><span class="comment">	out.writeUTF(name);// 将类名写入  com.jzg.quartz.job.task.TestTask$Person</span></span><br><span class="line"><span class="comment">	out.writeLong(getSerialVersionUID());// 将class的序列化编号写入</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	byte flags = 0;</span></span><br><span class="line"><span class="comment">	if (externalizable) &#123;</span></span><br><span class="line"><span class="comment">		flags |= ObjectStreamConstants.SC_EXTERNALIZABLE;</span></span><br><span class="line"><span class="comment">		int protocol = out.getProtocolVersion();</span></span><br><span class="line"><span class="comment">		if (protocol != ObjectStreamConstants.PROTOCOL_VERSION_1) &#123;</span></span><br><span class="line"><span class="comment">			flags |= ObjectStreamConstants.SC_BLOCK_DATA;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125; else if (serializable) &#123;</span></span><br><span class="line"><span class="comment">		flags |= ObjectStreamConstants.SC_SERIALIZABLE;// 序列化是001</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	if (hasWriteObjectData) &#123;</span></span><br><span class="line"><span class="comment">		flags |= ObjectStreamConstants.SC_WRITE_METHOD;// 有没有写入其它数据是010</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	if (isEnum) &#123;</span></span><br><span class="line"><span class="comment">		flags |= ObjectStreamConstants.SC_ENUM;// 是不是enum是10000</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	out.writeByte(flags);// 将是否是序列化，是否是自定义序列化，是否是枚举，是否有自定义字段需要持久化，标志位写入</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	out.writeShort(fields.length);// 将要序列化的属性字段的数量写入</span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; fields.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		ObjectStreamField f = fields[i];</span></span><br><span class="line"><span class="comment">		out.writeByte(f.getTypeCode());// 将要序列化的属性字段的类型（一个字节）写入</span></span><br><span class="line"><span class="comment">		out.writeUTF(f.getName());// 将属性字段的名字写入</span></span><br><span class="line"><span class="comment">		if (!f.isPrimitive()) &#123;// 如果字段不是原始类型的字段，将该属性字段的类型写入</span></span><br><span class="line"><span class="comment">			out.writeTypeString(f.getTypeString());</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Class&lt;?&gt; cl = desc.forClass();</span><br><span class="line">	bout.setBlockDataMode(<span class="keyword">true</span>);<span class="comment">// 转换模式成块模式，会将缓存中的字节写到buffer中去</span></span><br><span class="line">	<span class="keyword">if</span> (cl != <span class="keyword">null</span> &amp;&amp; isCustomSubclass()) &#123;</span><br><span class="line">		ReflectUtil.checkPackageAccess(cl);</span><br><span class="line">	&#125;</span><br><span class="line">	annotateClass(cl);<span class="comment">// 空</span></span><br><span class="line">	bout.setBlockDataMode(<span class="keyword">false</span>);<span class="comment">// 转换模式，会将缓存中的数据写出到buffer</span></span><br><span class="line">	bout.writeByte(TC_ENDBLOCKDATA);<span class="comment">// 结束该类型描述块的写入 (byte)0x78; </span></span><br><span class="line"></span><br><span class="line">	writeClassDesc(desc.getSuperDesc(), <span class="keyword">false</span>);<span class="comment">// 将父类的对象描述信息写入</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>写入属性字段数据<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeSerialData</span><span class="params">(Object obj, ObjectStreamClass desc)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">	ObjectStreamClass.ClassDataSlot[] slots = desc.getClassDataLayout();<span class="comment">// 获取当前ObjectStreamClass描述的可序列化的当前类及父类的槽数组</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; slots.length; i++) &#123;</span><br><span class="line">		ObjectStreamClass slotDesc = slots[i].desc;<span class="comment">// 拿到第一个可序列化的ObjectStreamClass描述</span></span><br><span class="line">		<span class="keyword">if</span> (slotDesc.hasWriteObjectMethod()) &#123;</span><br><span class="line">			PutFieldImpl oldPut = curPut;</span><br><span class="line">			curPut = <span class="keyword">null</span>;</span><br><span class="line">			SerialCallbackContext oldContext = curContext;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">				debugInfoStack.push(</span><br><span class="line">					<span class="string">"custom writeObject data (class \""</span> +</span><br><span class="line">					slotDesc.getName() + <span class="string">"\")"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				curContext = <span class="keyword">new</span> SerialCallbackContext(obj, slotDesc);</span><br><span class="line">				bout.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">				slotDesc.invokeWriteObject(obj, <span class="keyword">this</span>);</span><br><span class="line">				bout.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">				bout.writeByte(TC_ENDBLOCKDATA);</span><br><span class="line">			&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">				curContext.setUsed();</span><br><span class="line">				curContext = oldContext;</span><br><span class="line">				<span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">					debugInfoStack.pop();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			curPut = oldPut;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			defaultWriteFields(obj, slotDesc);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">private void defaultWriteFields(Object obj, ObjectStreamClass desc) throws IOException&#123;</span></span><br><span class="line"><span class="comment">	Class&lt;?&gt; cl = desc.forClass();</span></span><br><span class="line"><span class="comment">	if (cl != null &amp;&amp; obj != null &amp;&amp; !cl.isInstance(obj)) &#123;</span></span><br><span class="line"><span class="comment">		throw new ClassCastException();</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	desc.checkDefaultSerialize();// 校验是否实现了序列化接口</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	int primDataSize = desc.getPrimDataSize();// 拿到该class原始数据的字节数</span></span><br><span class="line"><span class="comment">	if (primVals == null || primVals.length &lt; primDataSize) &#123;</span></span><br><span class="line"><span class="comment">		primVals = new byte[primDataSize];// 将存储原始数据的字节数组长度设置成原始数据的字节总数</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	// 将所有的原始数据值保存在字节数组primVals中</span></span><br><span class="line"><span class="comment">	desc.getPrimFieldValues(obj, primVals);</span></span><br><span class="line"><span class="comment">	bout.write(primVals, 0, primDataSize, false);// 将原始数据写入输出流中</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	ObjectStreamField[] fields = desc.getFields(false);// 获取Class的属性字段数组ObjectStreamField</span></span><br><span class="line"><span class="comment">	Object[] objVals = new Object[desc.getNumObjFields()];// 创建属性字段非原始数据类型的数量的数组</span></span><br><span class="line"><span class="comment">	int numPrimFields = fields.length - objVals.length;// 拿到所有原始数据类型的字段数量</span></span><br><span class="line"><span class="comment">	desc.getObjFieldValues(obj, objVals);// 将所有非原始数据类型的属性字段保存在objVals对象数组中</span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; objVals.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		if (extendedDebugInfo) &#123;</span></span><br><span class="line"><span class="comment">			debugInfoStack.push(</span></span><br><span class="line"><span class="comment">				"field (class \"" + desc.getName() + "\", name: \"" +</span></span><br><span class="line"><span class="comment">				fields[numPrimFields + i].getName() + "\", type: \"" +</span></span><br><span class="line"><span class="comment">				fields[numPrimFields + i].getType() + "\")");</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		try &#123;</span></span><br><span class="line"><span class="comment">			writeObject0(objVals[i], fields[numPrimFields + i].isUnshared());// 将非原始类型的属性字段以Object序列化的形式写入输出流中</span></span><br><span class="line"><span class="comment">		&#125; finally &#123;</span></span><br><span class="line"><span class="comment">			if (extendedDebugInfo) &#123;</span></span><br><span class="line"><span class="comment">				debugInfoStack.pop();</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>获取当前类及父类的ObjectStreamClass的槽数组<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">ClassDataSlot[] getClassDataLayout() <span class="keyword">throws</span> InvalidClassException &#123; <span class="comment">// 获取所有当前类及父类可序列化的ObjectStreamClass数组</span></span><br><span class="line">	<span class="comment">// REMIND: synchronize instead of relying on volatile?</span></span><br><span class="line">	<span class="keyword">if</span> (dataLayout == <span class="keyword">null</span>) &#123;</span><br><span class="line">		dataLayout = getClassDataLayout0();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> dataLayout;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ClassDataSlot[] getClassDataLayout0() <span class="keyword">throws</span> InvalidClassException&#123;</span><br><span class="line">	ArrayList&lt;ClassDataSlot&gt; slots = <span class="keyword">new</span> ArrayList&lt;&gt;();<span class="comment">// 创建一个集合，用来保存ClassDataSlot</span></span><br><span class="line">	Class&lt;?&gt; start = cl, end = cl;</span><br><span class="line">	<span class="keyword">while</span> (end != <span class="keyword">null</span> &amp;&amp; Serializable.class.isAssignableFrom(end)) &#123;<span class="comment">// 找到最顶级的不可以序列化的那个父类，保存到end变量中</span></span><br><span class="line">		end = end.getSuperclass();</span><br><span class="line">	&#125;</span><br><span class="line">	HashSet&lt;String&gt; oscNames = <span class="keyword">new</span> HashSet&lt;&gt;(<span class="number">3</span>);<span class="comment">// 保存ObjectStreamClass的set集合</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (ObjectStreamClass d = <span class="keyword">this</span>; d != <span class="keyword">null</span>; d = d.superDesc) &#123;</span><br><span class="line">		<span class="keyword">if</span> (oscNames.contains(d.name)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(<span class="string">"Circular reference."</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			oscNames.add(d.name);<span class="comment">// 将当前要序列化的Object的全限定名保存到oscNames集合中</span></span><br><span class="line">		&#125;</span><br><span class="line">		String searchName = (d.cl != <span class="keyword">null</span>) ? d.cl.getName() : d.name;<span class="comment">// 拿到要序列化的对象的全限定名</span></span><br><span class="line">		Class&lt;?&gt; match = <span class="keyword">null</span>; <span class="comment">// 将要序列化对象的class找到</span></span><br><span class="line">		<span class="keyword">for</span> (Class&lt;?&gt; c = start; c != end; c = c.getSuperclass()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (searchName.equals(c.getName())) &#123;</span><br><span class="line">				match = c;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// add "no data" slot for each unmatched class below match</span></span><br><span class="line">		<span class="keyword">if</span> (match != <span class="keyword">null</span>) &#123; <span class="comment">// 如果能拿到要序列化对象的class</span></span><br><span class="line">			<span class="keyword">for</span> (Class&lt;?&gt; c = start; c != match; c = c.getSuperclass()) &#123;</span><br><span class="line">				slots.add(<span class="keyword">new</span> ClassDataSlot(ObjectStreamClass.lookup(c, <span class="keyword">true</span>), <span class="keyword">false</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			start = match.getSuperclass();<span class="comment">// 这里的start就变成了class java.lang.Object</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// record descriptor/class pairing</span></span><br><span class="line">		slots.add(<span class="keyword">new</span> ClassDataSlot(d.getVariantFor(match), <span class="keyword">true</span>));<span class="comment">// 序列化类的数据槽集合中添加一个新的ClassDataSlot</span></span><br><span class="line"><span class="comment">/*static class ClassDataSlot &#123;</span></span><br><span class="line"><span class="comment">	final ObjectStreamClass desc;</span></span><br><span class="line"><span class="comment">	final boolean hasData;</span></span><br><span class="line"><span class="comment">	ClassDataSlot(ObjectStreamClass desc, boolean hasData) &#123;</span></span><br><span class="line"><span class="comment">		this.desc = desc;// class描述</span></span><br><span class="line"><span class="comment">		this.hasData = hasData;// 是否有数据</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// add "no data" slot for any leftover unmatched classes</span></span><br><span class="line">	<span class="keyword">for</span> (Class&lt;?&gt; c = start; c != end; c = c.getSuperclass()) &#123;</span><br><span class="line">		slots.add(<span class="keyword">new</span> ClassDataSlot(</span><br><span class="line">			ObjectStreamClass.lookup(c, <span class="keyword">true</span>), <span class="keyword">false</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// order slots from superclass -&gt; subclass</span></span><br><span class="line">	Collections.reverse(slots);<span class="comment">// 反向排序</span></span><br><span class="line">	<span class="keyword">return</span> slots.toArray(<span class="keyword">new</span> ClassDataSlot[slots.size()]);<span class="comment">// 将slots的Set集合转换成ClassDataSlot的数组返回</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总结：</p>
<p>Object序列化需要生成一个Class的描述信息ObjectStreamClass，以及可序列化的父类描述信息</p>
<p>可序列化类的ObjectStreamClass描述信息，里面存储信息如下</p>
<ul>
<li>当前类的Class       cl</li>
<li>当前类的全限定名称   name</li>
<li>是否是代理           isProxy</li>
<li>是否是枚举           isEnum</li>
<li><p>是否是自定义序列化   serializable、externalizable</p>
</li>
<li><p>可序列化父类的ObjectStreamClass描述信息 superDesc</p>
</li>
<li><p>当前类的      ObjectStreamClass描述信息 localDesc</p>
</li>
<li><p>可序列化的当前类的属性字段（父类的可序列化属性字段由父类desc保存）  fields</p>
</li>
<li>原始数据类型的属性字段在对象中的偏移量，及占用字节总数   f.setOffset(primDataSize)，offset保存的是当前原始数据属性在字节数组的下标，primDataSize保存的是原始数据属性占用的字节总数。这些都是保存在ObjectStreamClass里面</li>
<li><p>非原始数据类型的属性字段在对象中的个数，及第一个非原始数据类型的属性字段在所有属性字段数组中的第几个    f.setOffset(numObjFields++); offset保存的是第几个非原始数据类型的属性，numObjFields保存的是有多少个非原始数据类型的属性字段</p>
</li>
<li><p>父类的构造函数（最顶级不可序列化的父类）</p>
</li>
<li>writeObject方法</li>
<li>readObject方法</li>
<li>readObjectNoData方法</li>
<li><p>是否有writeObject方法</p>
</li>
<li><p>writeReplace方法</p>
</li>
<li>readResolveMethod方法</li>
</ul>
<p>FieldReflector对象，里面储存信息如下：</p>
<ul>
<li>当前类可序列化属性字段  fields</li>
<li>当前类可序列化属性字段数目  nfields</li>
<li>属性字段内存地址偏移量  readKeys</li>
<li>属性字段内存地址偏移量  writeKeys</li>
<li>属性字段字节数组偏移量      offsets</li>
<li>属性字段类型        typeCodes</li>
<li>非原始数据类型属性字段的全限定名称  types</li>
<li>原始数据类型属性字段的数量    numPrimFields</li>
</ul>
<p>写入数据之类描述信息</p>
<ul>
<li>对象的全限定名称</li>
<li>序列化版本号</li>
<li>是否是自定义序列化、有没有writeObject方法、是否是枚举类型</li>
<li><p>可序列化属性字段的数量</p>
</li>
<li><p>属性字段的字符类型</p>
</li>
<li>属性字段的名称</li>
<li><p>非原始属性字段的类型全限定名</p>
</li>
<li><p>可序列化父类的类型描述信息</p>
</li>
</ul>
<p>写入数据之属性字段值</p>
<ul>
<li><p>生成一个ClassDataSlot数组，里面保存当前类及父类的ObjectStreamClass描述信息</p>
</li>
<li><p>写入原始数据属性字段的值，临时字节数组primVals</p>
<ul>
<li>从FieldReflector中拿到原始数据类型的类型字符（typeCode[i]），判断需要写入的字节长度</li>
<li>拿出属性字段的字节数组偏移量offsets[i]</li>
<li>根据内存地址偏移量（readKeys[i]）拿出字段值</li>
<li>写入字节数组primVals中</li>
<li>将字节数组写入到持久化输出流中</li>
</ul>
</li>
</ul>
<ul>
<li>写入非原始数据属性字段的值，临时对象数组vals[]<ul>
<li>从FieldReflector中拿到非原始数据类型的属性字段，从原始数据类型的数量作为下标从fields中拿到非原始数据类型的ObjectStreamField值</li>
<li>从typeCodes[numPrimFields++]中拿出非原始属性字段的字符类型</li>
<li>从offsets[numPrimFields++]中拿出非原始数据属性Field的offset值，offset[numPrimFields]值是从0开始++的</li>
<li>从readKeys[i]拿到非原始数据类型的属性字段的内存地址偏移量</li>
<li>vals[offsets[i]]设置上对象的引用</li>
<li>遍历vals[]非原始数据类型属性，然后再将该对象按照序列化对象的步骤写入到持久化输出流中</li>
</ul>
</li>
</ul>
<h3 id="Object反序列化"><a href="#Object反序列化" class="headerlink" title="Object反序列化"></a>Object反序列化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">readObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (enableOverride) &#123;</span><br><span class="line">		<span class="keyword">return</span> readObjectOverride();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> outerHandle = passHandle;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Object obj = readObject0(<span class="keyword">false</span>);</span><br><span class="line">		handles.markDependency(outerHandle, passHandle);</span><br><span class="line">		ClassNotFoundException ex = handles.lookupException(passHandle);</span><br><span class="line">		<span class="keyword">if</span> (ex != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (depth == <span class="number">0</span>) &#123;</span><br><span class="line">			vlist.doCallbacks();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> obj;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		passHandle = outerHandle;</span><br><span class="line">		<span class="keyword">if</span> (closed &amp;&amp; depth == <span class="number">0</span>) &#123;</span><br><span class="line">			clear();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readObject0</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException </span>&#123; <span class="comment">// 将对象从输入流中读取并转换</span></span><br><span class="line">	<span class="keyword">boolean</span> oldMode = bin.getBlockDataMode();</span><br><span class="line">	<span class="keyword">if</span> (oldMode) &#123;</span><br><span class="line">		<span class="keyword">int</span> remain = bin.currentBlockRemaining();</span><br><span class="line">		<span class="keyword">if</span> (remain &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(remain);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultDataEnd) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(<span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		bin.setBlockDataMode(<span class="keyword">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">byte</span> tc;</span><br><span class="line">	<span class="keyword">while</span> ((tc = bin.peekByte()) == TC_RESET) &#123;<span class="comment">// 拿出第一个字节出来</span></span><br><span class="line">		bin.readByte();</span><br><span class="line">		handleReset();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	depth++;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> (tc) &#123;</span><br><span class="line">			<span class="keyword">case</span> TC_NULL:</span><br><span class="line">				<span class="keyword">return</span> readNull();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_REFERENCE:</span><br><span class="line">				<span class="keyword">return</span> readHandle(unshared);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_CLASS:</span><br><span class="line">				<span class="keyword">return</span> readClass(unshared);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_CLASSDESC:</span><br><span class="line">			<span class="keyword">case</span> TC_PROXYCLASSDESC:</span><br><span class="line">				<span class="keyword">return</span> readClassDesc(unshared);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_STRING:</span><br><span class="line">			<span class="keyword">case</span> TC_LONGSTRING:</span><br><span class="line">				<span class="keyword">return</span> checkResolve(readString(unshared));</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_ARRAY:</span><br><span class="line">				<span class="keyword">return</span> checkResolve(readArray(unshared));</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_ENUM:</span><br><span class="line">				<span class="keyword">return</span> checkResolve(readEnum(unshared));</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_OBJECT:</span><br><span class="line">				<span class="keyword">return</span> checkResolve(readOrdinaryObject(unshared));<span class="comment">// 如果读取的是Object对象</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_EXCEPTION:</span><br><span class="line">				IOException ex = readFatalException();</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> WriteAbortedException(<span class="string">"writing aborted"</span>, ex);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_BLOCKDATA:</span><br><span class="line">			<span class="keyword">case</span> TC_BLOCKDATALONG:</span><br><span class="line">				<span class="keyword">if</span> (oldMode) &#123;</span><br><span class="line">					bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">					bin.peek();             <span class="comment">// force header read</span></span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(bin.currentBlockRemaining());</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(<span class="string">"unexpected block data"</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">case</span> TC_ENDBLOCKDATA:</span><br><span class="line">				<span class="keyword">if</span> (oldMode) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> OptionalDataException(<span class="keyword">true</span>);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(<span class="string">"unexpected end of block data"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(String.format(<span class="string">"invalid type code: %02X"</span>, tc));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		depth--;</span><br><span class="line">		bin.setBlockDataMode(oldMode);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读取数据并返回Object对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readOrdinaryObject</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bin.readByte() != TC_OBJECT) &#123;<span class="comment">// 开始拿出一个字节判断是否是Object对象流</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ObjectStreamClass desc = readClassDesc(<span class="keyword">false</span>);<span class="comment">// 读取ObjectStreamClass对象描述信息</span></span><br><span class="line">	desc.checkDeserialize();</span><br><span class="line">	Class&lt;?&gt; cl = desc.forClass();</span><br><span class="line">	<span class="keyword">if</span> (cl == String.class || cl == Class.class || cl == ObjectStreamClass.class) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(<span class="string">"invalid class descriptor"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	Object obj;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		obj = desc.isInstantiable() ? desc.newInstance() : <span class="keyword">null</span>;<span class="comment">// 创建Object实例，通过构造函数</span></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> (IOException) <span class="keyword">new</span> InvalidClassException(desc.forClass().getName(),<span class="string">"unable to create instance"</span>).initCause(ex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	passHandle = handles.assign(unshared ? unsharedMarker : obj);</span><br><span class="line">	ClassNotFoundException resolveEx = desc.getResolveException();</span><br><span class="line">	<span class="keyword">if</span> (resolveEx != <span class="keyword">null</span>) &#123;</span><br><span class="line">		handles.markException(passHandle, resolveEx);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (desc.isExternalizable()) &#123;</span><br><span class="line">		readExternalData((Externalizable) obj, desc);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		readSerialData(obj, desc);<span class="comment">// 读取属性字段的值</span></span><br><span class="line"><span class="comment">/*private void readSerialData(Object obj, ObjectStreamClass desc) throws IOException&#123;</span></span><br><span class="line"><span class="comment">	ObjectStreamClass.ClassDataSlot[] slots = desc.getClassDataLayout();// 拿到当前类及父类的类描述</span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; slots.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		ObjectStreamClass slotDesc = slots[i].desc;</span></span><br><span class="line"><span class="comment">		if (slots[i].hasData) &#123;</span></span><br><span class="line"><span class="comment">			if (obj == null || handles.lookupException(passHandle) != null) &#123;</span></span><br><span class="line"><span class="comment">				defaultReadFields(null, slotDesc); // skip field values</span></span><br><span class="line"><span class="comment">			&#125; else if (slotDesc.hasReadObjectMethod()) &#123;</span></span><br><span class="line"><span class="comment">				SerialCallbackContext oldContext = curContext;</span></span><br><span class="line"><span class="comment">				if (oldContext != null)</span></span><br><span class="line"><span class="comment">					oldContext.check();</span></span><br><span class="line"><span class="comment">				try &#123;</span></span><br><span class="line"><span class="comment">					curContext = new SerialCallbackContext(obj, slotDesc);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">					bin.setBlockDataMode(true);</span></span><br><span class="line"><span class="comment">					slotDesc.invokeReadObject(obj, this);</span></span><br><span class="line"><span class="comment">				&#125; catch (ClassNotFoundException ex) &#123;</span></span><br><span class="line"><span class="comment">					handles.markException(passHandle, ex);</span></span><br><span class="line"><span class="comment">				&#125; finally &#123;</span></span><br><span class="line"><span class="comment">					curContext.setUsed();</span></span><br><span class="line"><span class="comment">					if (oldContext!= null)</span></span><br><span class="line"><span class="comment">						oldContext.check();</span></span><br><span class="line"><span class="comment">					curContext = oldContext;</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">				defaultDataEnd = false;</span></span><br><span class="line"><span class="comment">			&#125; else &#123;</span></span><br><span class="line"><span class="comment">				defaultReadFields(obj, slotDesc);// 默认读取属性字段的值</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">			if (slotDesc.hasWriteObjectData()) &#123;</span></span><br><span class="line"><span class="comment">				skipCustomData();</span></span><br><span class="line"><span class="comment">			&#125; else &#123;</span></span><br><span class="line"><span class="comment">				bin.setBlockDataMode(false);</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125; else &#123;</span></span><br><span class="line"><span class="comment">			if (obj != null &amp;&amp; slotDesc.hasReadObjectNoDataMethod() &amp;&amp;	handles.lookupException(passHandle) == null)&#123;</span></span><br><span class="line"><span class="comment">				slotDesc.invokeReadObjectNoData(obj);</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">private void defaultReadFields(Object obj, ObjectStreamClass desc) throws IOException&#123;</span></span><br><span class="line"><span class="comment">	Class&lt;?&gt; cl = desc.forClass();// 拿到类的Class</span></span><br><span class="line"><span class="comment">	if (cl != null &amp;&amp; obj != null &amp;&amp; !cl.isInstance(obj)) &#123;</span></span><br><span class="line"><span class="comment">		throw new ClassCastException();</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	int primDataSize = desc.getPrimDataSize();// 获取原始数据字节长度</span></span><br><span class="line"><span class="comment">	if (primVals == null || primVals.length &lt; primDataSize) &#123;</span></span><br><span class="line"><span class="comment">		primVals = new byte[primDataSize];// 创建原始数据字节长度的数组</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	bin.readFully(primVals, 0, primDataSize, false);// 读取原始数据字节长度的值，放入到字节数组中</span></span><br><span class="line"><span class="comment">	if (obj != null) &#123;</span></span><br><span class="line"><span class="comment">		desc.setPrimFieldValues(obj, primVals);// 将原始数据的值放入对象属性字段上</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	int objHandle = passHandle;</span></span><br><span class="line"><span class="comment">	ObjectStreamField[] fields = desc.getFields(false);// 获取所有属性字段</span></span><br><span class="line"><span class="comment">	Object[] objVals = new Object[desc.getNumObjFields()];// 创建一个非原始数据类型的属性字段个数的数组</span></span><br><span class="line"><span class="comment">	int numPrimFields = fields.length - objVals.length;</span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; objVals.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		ObjectStreamField f = fields[numPrimFields + i];</span></span><br><span class="line"><span class="comment">		objVals[i] = readObject0(f.isUnshared());// 开始读取非原始数据属性字段的值，跟读取要序列化对象的方式一样</span></span><br><span class="line"><span class="comment">		if (f.getField() != null) &#123;</span></span><br><span class="line"><span class="comment">			handles.markDependency(objHandle, passHandle);</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	if (obj != null) &#123;</span></span><br><span class="line"><span class="comment">		desc.setObjFieldValues(obj, objVals);// 对每个非原始数据类型的属性字段赋值</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	passHandle = objHandle;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">void setPrimFieldValues(Object obj, byte[] buf) &#123;</span></span><br><span class="line"><span class="comment">	fieldRefl.setPrimFieldValues(obj, buf);// 使用的是ObjectStreamClass中的FieldReflector</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">void setPrimFieldValues(Object obj, byte[] buf) &#123;</span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; numPrimFields; i++) &#123;// 拿到原始数据属性的数量</span></span><br><span class="line"><span class="comment">		long key = writeKeys[i];// 该属性字段的对象内存的偏移量</span></span><br><span class="line"><span class="comment">		if (key == Unsafe.INVALID_FIELD_OFFSET) &#123;</span></span><br><span class="line"><span class="comment">			continue;           // discard value</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		int off = offsets[i];// 在数组哪个下标开始读取字节</span></span><br><span class="line"><span class="comment">		switch (typeCodes[i]) &#123;// 判断原始数据类型</span></span><br><span class="line"><span class="comment">			case 'Z':</span></span><br><span class="line"><span class="comment">				unsafe.putBoolean(obj, key, Bits.getBoolean(buf, off));</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			case 'B':</span></span><br><span class="line"><span class="comment">				unsafe.putByte(obj, key, buf[off]);</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			case 'C':</span></span><br><span class="line"><span class="comment">				unsafe.putChar(obj, key, Bits.getChar(buf, off));</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			case 'S':</span></span><br><span class="line"><span class="comment">				unsafe.putShort(obj, key, Bits.getShort(buf, off));</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			case 'I':</span></span><br><span class="line"><span class="comment">				unsafe.putInt(obj, key, Bits.getInt(buf, off));</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			case 'F':</span></span><br><span class="line"><span class="comment">				unsafe.putFloat(obj, key, Bits.getFloat(buf, off));</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			case 'J':</span></span><br><span class="line"><span class="comment">				unsafe.putLong(obj, key, Bits.getLong(buf, off));</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			case 'D':</span></span><br><span class="line"><span class="comment">				unsafe.putDouble(obj, key, Bits.getDouble(buf, off));</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			default:</span></span><br><span class="line"><span class="comment">				throw new InternalError();</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">void setObjFieldValues(Object obj, Object[] vals) &#123;</span></span><br><span class="line"><span class="comment">	fieldRefl.setObjFieldValues(obj, vals);// 非原始属性字段的赋值也是通过FieldReflector实现的</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">void setObjFieldValues(Object obj, Object[] vals) &#123;</span></span><br><span class="line"><span class="comment">	for (int i = numPrimFields; i &lt; fields.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		long key = writeKeys[i]; // 该属性字段的对象内存的偏移量</span></span><br><span class="line"><span class="comment">		if (key == Unsafe.INVALID_FIELD_OFFSET) &#123;</span></span><br><span class="line"><span class="comment">			continue;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		switch (typeCodes[i]) &#123;</span></span><br><span class="line"><span class="comment">			case 'L':</span></span><br><span class="line"><span class="comment">			case '[':</span></span><br><span class="line"><span class="comment">				Object val = vals[offsets[i]];// offsets[i]中保存的是第几个（从0开始）非原始数据类型的属性字段</span></span><br><span class="line"><span class="comment">				if (val != null &amp;&amp; !types[i - numPrimFields].isInstance(val))&#123;</span></span><br><span class="line"><span class="comment">					Field f = fields[i].getField();</span></span><br><span class="line"><span class="comment">					throw new ClassCastException("cannot assign instance of " + val.getClass().getName() + " to field " + f.getDeclaringClass().getName() + "." + f.getName() + " of type " + f.getType().getName() + " in instance of " + obj.getClass().getName());</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">				unsafe.putObject(obj, key, val);</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			default: throw new InternalError();</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">	&#125;</span><br><span class="line">	handles.finish(passHandle);</span><br><span class="line">	<span class="keyword">if</span> (obj != <span class="keyword">null</span> &amp;&amp;	handles.lookupException(passHandle) == <span class="keyword">null</span> &amp;&amp; desc.hasReadResolveMethod())&#123;<span class="comment">// 如果实现了readResolve方法，直接通过反射调用获取对象即可</span></span><br><span class="line">		Object rep = desc.invokeReadResolve(obj);</span><br><span class="line">		<span class="keyword">if</span> (unshared &amp;&amp; rep.getClass().isArray()) &#123;</span><br><span class="line">			rep = cloneArray(rep);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (rep != obj) &#123;</span><br><span class="line">			handles.setObject(passHandle, obj = rep);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>读取对象描述信息（readDesc）并将本地对象描述信息localDesc拷贝到readDesc中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ObjectStreamClass <span class="title">readClassDesc</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">	<span class="keyword">byte</span> tc = bin.peekByte();<span class="comment">// 拿出一个字节来判断，是否是对象描述信息流</span></span><br><span class="line">	<span class="keyword">switch</span> (tc) &#123;</span><br><span class="line">		<span class="keyword">case</span> TC_NULL:</span><br><span class="line">			<span class="keyword">return</span> (ObjectStreamClass) readNull();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> TC_REFERENCE:</span><br><span class="line">			<span class="keyword">return</span> (ObjectStreamClass) readHandle(unshared);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> TC_PROXYCLASSDESC:</span><br><span class="line">			<span class="keyword">return</span> readProxyDesc(unshared);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> TC_CLASSDESC:</span><br><span class="line">			<span class="keyword">return</span> readNonProxyDesc(unshared);<span class="comment">// 开始读取对象描述信息ObjectStreamClass</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> StreamCorruptedException(</span><br><span class="line">				String.format(<span class="string">"invalid type code: %02X"</span>, tc));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> ObjectStreamClass <span class="title">readNonProxyDesc</span><span class="params">(<span class="keyword">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bin.readByte() != TC_CLASSDESC) &#123;<span class="comment">// 再次校验一下，是否是对象描述信息</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">	&#125;</span><br><span class="line">	ObjectStreamClass desc = <span class="keyword">new</span> ObjectStreamClass();</span><br><span class="line">	<span class="keyword">int</span> descHandle = handles.assign(unshared ? unsharedMarker : desc);</span><br><span class="line">	passHandle = NULL_HANDLE;</span><br><span class="line">	ObjectStreamClass readDesc = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		readDesc = readClassDescriptor();<span class="comment">// 解析输入流中的文件描述信息</span></span><br><span class="line">	&#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> (IOException) <span class="keyword">new</span> InvalidClassException(<span class="string">"failed to read class descriptor"</span>).initCause(ex);</span><br><span class="line">	&#125;</span><br><span class="line">	Class&lt;?&gt; cl = <span class="keyword">null</span>;</span><br><span class="line">	ClassNotFoundException resolveEx = <span class="keyword">null</span>;</span><br><span class="line">	bin.setBlockDataMode(<span class="keyword">true</span>);</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> checksRequired = isCustomSubclass();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ((cl = resolveClass(readDesc)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">			resolveEx = <span class="keyword">new</span> ClassNotFoundException(<span class="string">"null class"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (checksRequired) &#123;</span><br><span class="line">			ReflectUtil.checkPackageAccess(cl);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">		resolveEx = ex;</span><br><span class="line">	&#125;</span><br><span class="line">	skipCustomData();</span><br><span class="line"></span><br><span class="line">	desc.initNonProxy(readDesc, cl, resolveEx, readClassDesc(<span class="keyword">false</span>));<span class="comment">// 初始化对象描述</span></span><br><span class="line"><span class="comment">/*void initNonProxy(ObjectStreamClass model,Class&lt;?&gt; cl,ClassNotFoundException resolveEx,ObjectStreamClass superDesc) throws InvalidClassException&#123;</span></span><br><span class="line"><span class="comment">	this.cl = cl;// 将object的class保存起来</span></span><br><span class="line"><span class="comment">	this.resolveEx = resolveEx;</span></span><br><span class="line"><span class="comment">	this.superDesc = superDesc;// 将父类的对象描述保存起来</span></span><br><span class="line"><span class="comment">	name = model.name;// 类名称</span></span><br><span class="line"><span class="comment">	suid = Long.valueOf(model.getSerialVersionUID());// 版本号</span></span><br><span class="line"><span class="comment">	isProxy = false;// 非代理</span></span><br><span class="line"><span class="comment">	isEnum = model.isEnum;// 非枚举</span></span><br><span class="line"><span class="comment">	serializable = model.serializable;// 是否是常规序列化</span></span><br><span class="line"><span class="comment">	externalizable = model.externalizable;// 是否是自定义序列化</span></span><br><span class="line"><span class="comment">	hasBlockExternalData = model.hasBlockExternalData;// 是否有其它序列化数据</span></span><br><span class="line"><span class="comment">	hasWriteObjectData = model.hasWriteObjectData;// 是否重写writeObject方法</span></span><br><span class="line"><span class="comment">	fields = model.fields;// 属性字段</span></span><br><span class="line"><span class="comment">	primDataSize = model.primDataSize;// 原始数据字段字节总数</span></span><br><span class="line"><span class="comment">	numObjFields = model.numObjFields;// 非原始数据字段数量</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	if (cl != null) &#123;</span></span><br><span class="line"><span class="comment">		localDesc = lookup(cl, true);// 查找class对应的对象描述信息</span></span><br><span class="line"><span class="comment">		if (localDesc.isProxy) &#123;</span></span><br><span class="line"><span class="comment">			throw new InvalidClassException("cannot bind non-proxy descriptor to a proxy class");</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		if (isEnum != localDesc.isEnum) &#123;</span></span><br><span class="line"><span class="comment">			throw new InvalidClassException(isEnum ? "cannot bind enum descriptor to a non-enum class" :"cannot bind non-enum descriptor to an enum class");</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		if (serializable == localDesc.serializable &amp;&amp; !cl.isArray() &amp;&amp; suid.longValue() != localDesc.getSerialVersionUID())&#123;// 如果序列化方式一样，版本号一样才可以反序列化</span></span><br><span class="line"><span class="comment">			throw new InvalidClassException(localDesc.name,"local class incompatible: " + "stream classdesc serialVersionUID = " + suid + ", local class serialVersionUID = " +	localDesc.getSerialVersionUID());</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		if (!classNamesEqual(name, localDesc.name)) &#123;</span></span><br><span class="line"><span class="comment">			throw new InvalidClassException(localDesc.name,"local class name incompatible with stream class " +	"name \"" + name + "\"");</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		if (!isEnum) &#123;// 如果不是枚举类型的,校验序列化类型</span></span><br><span class="line"><span class="comment">			if ((serializable == localDesc.serializable) &amp;&amp;	(externalizable != localDesc.externalizable))&#123;</span></span><br><span class="line"><span class="comment">				throw new InvalidClassException(localDesc.name,"Serializable incompatible with Externalizable");</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">			if ((serializable != localDesc.serializable) ||	(externalizable != localDesc.externalizable) ||	!(serializable || externalizable))</span></span><br><span class="line"><span class="comment">			&#123;</span></span><br><span class="line"><span class="comment">				deserializeEx = new ExceptionInfo(localDesc.name, "class invalid for deserialization");</span></span><br><span class="line"><span class="comment">			&#125;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		cons = localDesc.cons;// 将构造函数保存到ObjectStreamClass中</span></span><br><span class="line"><span class="comment">		writeObjectMethod = localDesc.writeObjectMethod;// 写入方法赋值</span></span><br><span class="line"><span class="comment">		readObjectMethod = localDesc.readObjectMethod; // 读取方法赋值</span></span><br><span class="line"><span class="comment">		readObjectNoDataMethod = localDesc.readObjectNoDataMethod; </span></span><br><span class="line"><span class="comment">		writeReplaceMethod = localDesc.writeReplaceMethod;// writeReplace方法赋值</span></span><br><span class="line"><span class="comment">		readResolveMethod = localDesc.readResolveMethod;// readResolve方法赋值</span></span><br><span class="line"><span class="comment">		if (deserializeEx == null) &#123;</span></span><br><span class="line"><span class="comment">			deserializeEx = localDesc.deserializeEx;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	fieldRefl = getReflector(fields, localDesc);// FieldReflector赋值</span></span><br><span class="line"><span class="comment">	fields = fieldRefl.getFields();// Fields赋值</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line">	handles.finish(descHandle);</span><br><span class="line">	passHandle = descHandle;</span><br><span class="line">	<span class="keyword">return</span> desc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>获取序列化信息中的对象描述信息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ObjectStreamClass <span class="title">readClassDescriptor</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">	ObjectStreamClass desc = <span class="keyword">new</span> ObjectStreamClass();</span><br><span class="line">	desc.readNonProxy(<span class="keyword">this</span>);<span class="comment">// 获取对象描述信息</span></span><br><span class="line">	<span class="keyword">return</span> desc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readNonProxy</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">	name = in.readUTF();<span class="comment">// 获取类名称</span></span><br><span class="line">	suid = Long.valueOf(in.readLong());<span class="comment">// 获取类的序列化编号</span></span><br><span class="line">	isProxy = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">byte</span> flags = in.readByte();<span class="comment">// 拿出标志位进行校验</span></span><br><span class="line">	hasWriteObjectData = ((flags &amp; ObjectStreamConstants.SC_WRITE_METHOD) != <span class="number">0</span>);<span class="comment">// 是否有writeObject方法</span></span><br><span class="line">	hasBlockExternalData = ((flags &amp; ObjectStreamConstants.SC_BLOCK_DATA) != <span class="number">0</span>);<span class="comment">// 是否有其它序列化数据</span></span><br><span class="line">	externalizable = ((flags &amp; ObjectStreamConstants.SC_EXTERNALIZABLE) != <span class="number">0</span>);<span class="comment">// 是否是自定义序列化</span></span><br><span class="line">	<span class="keyword">boolean</span> sflag = ((flags &amp; ObjectStreamConstants.SC_SERIALIZABLE) != <span class="number">0</span>);<span class="comment">// 是否是常规序列化</span></span><br><span class="line">	<span class="keyword">if</span> (externalizable &amp;&amp; sflag) &#123;<span class="comment">// 不允许既是常规序列化，又是自定义序列化</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(name, <span class="string">"serializable and externalizable flags conflict"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	serializable = externalizable || sflag;</span><br><span class="line">	isEnum = ((flags &amp; ObjectStreamConstants.SC_ENUM) != <span class="number">0</span>);<span class="comment">// 判断是否是枚举</span></span><br><span class="line">	<span class="keyword">if</span> (isEnum &amp;&amp; suid.longValue() != <span class="number">0L</span>) &#123;<span class="comment">// 枚举不允许有序列化版本号</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(name,<span class="string">"enum descriptor has non-zero serialVersionUID: "</span> + suid);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> numFields = in.readShort();<span class="comment">// 读取有多少个属性字段</span></span><br><span class="line">	<span class="keyword">if</span> (isEnum &amp;&amp; numFields != <span class="number">0</span>) &#123;<span class="comment">// 如果是枚举不允许有属性字段</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(name,<span class="string">"enum descriptor has non-zero field count: "</span> + numFields);</span><br><span class="line">	&#125;</span><br><span class="line">	fields = (numFields &gt; <span class="number">0</span>) ? <span class="keyword">new</span> ObjectStreamField[numFields] : NO_FIELDS;<span class="comment">// 创建ObjectStreamField数组用于保存描述信息</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numFields; i++) &#123;<span class="comment">// 遍历字段描述信息</span></span><br><span class="line">		<span class="keyword">char</span> tcode = (<span class="keyword">char</span>) in.readByte();</span><br><span class="line">		String fname = in.readUTF();<span class="comment">// 字段名称</span></span><br><span class="line">		String signature = ((tcode == <span class="string">'L'</span>) || (tcode == <span class="string">'['</span>)) ? in.readTypeString() : <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[] &#123; tcode &#125;);<span class="comment">// 字段类型。非原始数据类型，直接读取属性字段类型，原始数据类型就保存属性字段的字符类型</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			fields[i] = <span class="keyword">new</span> ObjectStreamField(fname, signature, <span class="keyword">false</span>);<span class="comment">// 生成一个该属性字段的ObjectStreamField描述信息</span></span><br><span class="line"><span class="comment">/*ObjectStreamField(String name, String signature, boolean unshared) &#123;</span></span><br><span class="line"><span class="comment">	if (name == null) &#123;</span></span><br><span class="line"><span class="comment">		throw new NullPointerException();</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	this.name = name;// 保存名字</span></span><br><span class="line"><span class="comment">	this.signature = signature.intern();// 保存类型或字符类型</span></span><br><span class="line"><span class="comment">	this.unshared = unshared;</span></span><br><span class="line"><span class="comment">	field = null;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	switch (signature.charAt(0)) &#123;// 判断字段类型，保存字段类型到type上</span></span><br><span class="line"><span class="comment">		case 'Z': type = Boolean.TYPE; break;</span></span><br><span class="line"><span class="comment">		case 'B': type = Byte.TYPE; break;</span></span><br><span class="line"><span class="comment">		case 'C': type = Character.TYPE; break;</span></span><br><span class="line"><span class="comment">		case 'S': type = Short.TYPE; break;</span></span><br><span class="line"><span class="comment">		case 'I': type = Integer.TYPE; break;</span></span><br><span class="line"><span class="comment">		case 'J': type = Long.TYPE; break;</span></span><br><span class="line"><span class="comment">		case 'F': type = Float.TYPE; break;</span></span><br><span class="line"><span class="comment">		case 'D': type = Double.TYPE; break;</span></span><br><span class="line"><span class="comment">		case 'L':</span></span><br><span class="line"><span class="comment">		case '[': type = Object.class; break;</span></span><br><span class="line"><span class="comment">		default: throw new IllegalArgumentException("illegal signature");</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> (IOException) <span class="keyword">new</span> InvalidClassException(name,<span class="string">"invalid descriptor for field "</span> + fname).initCause(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	computeFieldOffsets();<span class="comment">// 计算属性字段的偏移量</span></span><br><span class="line"><span class="comment">/*private void computeFieldOffsets() throws InvalidClassException &#123;</span></span><br><span class="line"><span class="comment">	primDataSize = 0;</span></span><br><span class="line"><span class="comment">	numObjFields = 0;</span></span><br><span class="line"><span class="comment">	int firstObjIndex = -1;</span></span><br><span class="line"><span class="comment">	for (int i = 0; i &lt; fields.length; i++) &#123;</span></span><br><span class="line"><span class="comment">		ObjectStreamField f = fields[i];</span></span><br><span class="line"><span class="comment">		switch (f.getTypeCode()) &#123;// 判断属性字段的类型，从signature.charAt(0)获取</span></span><br><span class="line"><span class="comment">			case 'Z':</span></span><br><span class="line"><span class="comment">			case 'B':</span></span><br><span class="line"><span class="comment">				f.setOffset(primDataSize++);</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			case 'C':</span></span><br><span class="line"><span class="comment">			case 'S':</span></span><br><span class="line"><span class="comment">				f.setOffset(primDataSize);</span></span><br><span class="line"><span class="comment">				primDataSize += 2;</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			case 'I':</span></span><br><span class="line"><span class="comment">			case 'F':</span></span><br><span class="line"><span class="comment">				f.setOffset(primDataSize);</span></span><br><span class="line"><span class="comment">				primDataSize += 4;</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			case 'J':</span></span><br><span class="line"><span class="comment">			case 'D':</span></span><br><span class="line"><span class="comment">				f.setOffset(primDataSize);</span></span><br><span class="line"><span class="comment">				primDataSize += 8;</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			case '[':</span></span><br><span class="line"><span class="comment">			case 'L':</span></span><br><span class="line"><span class="comment">				f.setOffset(numObjFields++);</span></span><br><span class="line"><span class="comment">				if (firstObjIndex == -1) &#123;</span></span><br><span class="line"><span class="comment">					firstObjIndex = i;</span></span><br><span class="line"><span class="comment">				&#125;</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">			default:</span></span><br><span class="line"><span class="comment">				throw new InternalError();</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	if (firstObjIndex != -1 &amp;&amp; firstObjIndex + numObjFields != fields.length)&#123;</span></span><br><span class="line"><span class="comment">		throw new InvalidClassException(name, "illegal field order");</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总结：<br>获取对象的文件描述信息</p>
<ul>
<li>创建一个ObjectStreamClass对象，变量名desc</li>
</ul>
<ul>
<li><p>创建一个ObjectStreamClass对象，变量名readDesc，表示是读取出来的文件描述信息</p>
<ul>
<li>对象全名称  name</li>
<li>对象版本号 suid</li>
<li>有没有writeObject方法  hasWriteObjectData</li>
<li>有没有额外数据写入    hasBlockExternalData</li>
<li>是否是自定义序列化    externalizable</li>
<li>是否是常规序列化      serializable</li>
<li><p>是否是枚举            isEnum</p>
</li>
<li><p>属性字段数量          numFields</p>
</li>
<li>属性字段名称          fname</li>
<li>属性字段类型          tcode</li>
<li>非原始数据字段类型全称  signature</li>
<li>原始数据字段字节数量   primDataSize</li>
<li>非原始数据字段数量     numObjFields</li>
<li>生成ObjectStreamField对象<ul>
<li>name：属性字段名称</li>
<li>signature：字段类型名称</li>
<li>type： 字段类型</li>
<li>offset：原始数据类型字段保存的是字节下标，非原始数据类型字段保存的是第几个非原始数据字段（从0开始）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>调用desc.initNonProxy(readDesc, cl, resolveEx, readClassDesc(false));//readClassDesc(false)是获取父类的class描述信息</p>
<ul>
<li>赋值class字段    cl是通过readDesc.name获取的</li>
<li>赋值resolveEx字段</li>
<li>赋值superDesc     是调用方法之前就读取到的父类的描述信息</li>
<li>赋值name          类名称（从readDesc获取）</li>
<li>赋值suid          版本号（从readDesc获取）</li>
<li>赋值isProxy        是否是代理类（从readDesc获取）</li>
<li>赋值isEnum         是否是枚举类（从readDesc获取）</li>
<li>赋值serializable    是否是常规序列化类（从readDesc获取）</li>
<li>赋值externalizable   是否是自定义序列化类（从readDesc获取）</li>
<li>赋值hasWriteObjectData  是否有额外数据序列化（从readDesc获取）</li>
<li>赋值fields             属性字段（从readDesc获取）</li>
<li>赋值primDataSize      原始数据字段字节数（从readDesc获取）</li>
<li>赋值numObjFields      非原始数据字段数量（从readDesc获取）</li>
</ul>
<p>根据class获取本服务器中对该类的描述信息，赋值给localDesc</p>
<ul>
<li>校验readDesc和localDesc的区别</li>
</ul>
<ul>
<li>赋值cons                 构造函数（从localDesc获取）</li>
<li>赋值writeObjectMethod      （从localDesc获取）</li>
<li>赋值readObjectMethod       （从localDesc获取）</li>
<li>赋值readObjectNoDataMethod   （从localDesc获取）</li>
<li>赋值writeReplaceMethod     （从localDesc获取）</li>
<li>赋值readResolveMethod      （从localDesc获取）</li>
<li><p>赋值deserializeEx           （从localDesc获取）</p>
</li>
<li><p>赋值fieldRefl             （从localDesc获取）//getReflector(readFields, localDesc); 因为之前调用过lookup(cl)，所以缓存中已经有这个fieldReflector了，直接就从缓存中拿了</p>
</li>
<li>重新赋值fields           （从fieldRefl获取）</li>
</ul>
<p>创建Object对象，通过cons.newInstance()</p>
<ul>
<li>从输入流中获取原始数据类型的属性字节数据，保存在primVals字节数组中</li>
<li>通过fieldReflector，将原始数据类型的字节数组数据写入到指定的原始数据内存偏移量地址上</li>
</ul>
<ul>
<li>从输入流中读取非原始数据类型属性字段（Object类型的反序列化）,保存到objVals数组中</li>
<li>通过fieldReflector，将非原始数据类型的数据保存到指定内存偏移地址上</li>
</ul>
<h3 id="Serializable序列化demo"><a href="#Serializable序列化demo" class="headerlink" title="Serializable序列化demo"></a>Serializable序列化demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 控制哪些字段需要序列化，使用serialPersistentFields属性</span></span><br><span class="line">	<span class="comment">// private static final ObjectStreamField[] serialPersistentFields = new ObjectStreamField[]&#123;new ObjectStreamField("name", String.class)&#125;;</span></span><br><span class="line">	<span class="comment">// 序列化编号，必须有</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6663004828040541458L</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">transient</span> String value;<span class="comment">// transient修饰的属性不会被默认序列化</span></span><br><span class="line">	<span class="keyword">private</span> Date date;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String version = <span class="string">"1.0"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		out.defaultWriteObject();<span class="comment">// 默认序列化属性字段</span></span><br><span class="line">		out.writeObject(value + <span class="string">" is transient"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">		in.defaultReadObject();<span class="comment">// 默认读取输入流序列化数据</span></span><br><span class="line">		value = (String) in.readObject();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Externalizable序列化demo<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Externalizable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6663004828040541458L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String version = <span class="string">"1.0"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        out.writeInt(age);</span><br><span class="line">        out.writeObject(name);</span><br><span class="line">        out.writeObject(value);</span><br><span class="line">        out.writeObject(date);</span><br><span class="line">        out.writeObject(version);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = in.readInt();</span><br><span class="line">        <span class="keyword">this</span>.name = (String) in.readObject();</span><br><span class="line">        <span class="keyword">this</span>.value = (String) in.readObject();</span><br><span class="line">        <span class="keyword">this</span>.date = (Date) in.readObject();</span><br><span class="line">        version = (String) in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.name = <span class="string">"lisi"</span>;</span><br><span class="line">        user.age = <span class="number">28</span>;</span><br><span class="line">        user.date = <span class="keyword">new</span> Date();</span><br><span class="line">        user.value = <span class="string">"abcd"</span>;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">writeReplace</span><span class="params">()</span></span>&#123;<span class="comment">// 替换成别的Object序列化</span></span><br><span class="line">        Person p = <span class="keyword">new</span> Person();</span><br><span class="line">        p.age=<span class="number">11</span>;</span><br><span class="line">        p.name=<span class="string">"wangwu"</span>;</span><br><span class="line">        p.value=<span class="string">"dddd"</span>;</span><br><span class="line">        p.date=<span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Main调用demo<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">"D:/private/serialize1.txt"</span>);</span><br><span class="line">    User p = <span class="keyword">new</span> User();</span><br><span class="line">    p.name = <span class="string">"zhangsan1"</span>;</span><br><span class="line">    p.value = <span class="string">"123"</span>;</span><br><span class="line">    p.age = <span class="number">21</span>;</span><br><span class="line">    p.date = <span class="keyword">new</span> Date();</span><br><span class="line">    p.version = <span class="string">"1.1"</span>;</span><br><span class="line">    ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">    out.writeObject(p);</span><br><span class="line">    out.close();</span><br><span class="line">    p.version = <span class="string">"3.0"</span>;</span><br><span class="line"></span><br><span class="line">    ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">    Person p2 = (Person) in.readObject();<span class="comment">// 序列化的对象已经替换成了Person对象</span></span><br><span class="line">    System.out.println(p2.name + <span class="string">","</span> + p2.value + <span class="string">","</span> + p2.age + <span class="string">","</span> + <span class="string">","</span> + p2.date + <span class="string">","</span> + p2.version);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>都是私房菜，整理不易，求鼓励，求支持，求生存！！！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/webzfbgetmsgimg.jpg" alt="menggl 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ObjectStreamClass/" rel="tag"># ObjectStreamClass</a>
          
            <a href="/tags/ObjectStreamField/" rel="tag"># ObjectStreamField</a>
          
            <a href="/tags/FieldReflector/" rel="tag"># FieldReflector</a>
          
            <a href="/tags/序列化和反序列化/" rel="tag"># 序列化和反序列化</a>
          
            <a href="/tags/Serializable/" rel="tag"># Serializable</a>
          
            <a href="/tags/Externalizable/" rel="tag"># Externalizable</a>
          
            <a href="/tags/readResolve/" rel="tag"># readResolve</a>
          
            <a href="/tags/writeObject/" rel="tag"># writeObject</a>
          
            <a href="/tags/readObject/" rel="tag"># readObject</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/13/2018-01-13强软弱虚引用及ThreadLocal源码解读/" rel="next" title="强软弱虚引用及ThreadLocal源码解读">
                <i class="fa fa-chevron-left"></i> 强软弱虚引用及ThreadLocal源码解读
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/02/21/2018-02-21idea工具的使用/" rel="prev" title="idea工具的使用">
                idea工具的使用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">menggl</p>
              <p class="site-description motion-element" itemprop="description">专注源码伍拾年</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Java对象序列化"><span class="nav-number">1.</span> <span class="nav-text">Java对象序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Object反序列化"><span class="nav-number">2.</span> <span class="nav-text">Object反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Serializable序列化demo"><span class="nav-number">3.</span> <span class="nav-text">Serializable序列化demo</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">menggl</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
